'use client';

import React, { useState, useEffect, useCallback, useRef } from 'react';
declare global {
  interface Window {
    _crashGameTarget?: number;
    _crashGameWin?: number;
    _crashGameIsWin?: boolean;
  }
}
import { motion, AnimatePresence } from 'framer-motion';
import {
  ArrowLeft,
  TrendingUp,
  Zap,
  DollarSign,
  Timer,
  Volume2,
  VolumeX,
  Target,
  AlertTriangle,
  ChevronUp,
  ChevronDown,
  Settings,
  RefreshCw,
  BarChart2,
  // History ÏïÑÏù¥ÏΩòÏùÄ window.History (Illegal constructor) ÎÑ§Ïù¥Ìã∞Î∏å Í∞ùÏ≤¥ÏôÄ Ïù¥Î¶Ñ Ï∂©Îèå Í∞ÄÎä•ÏÑ± ÏûàÏúºÎØÄÎ°ú alias
  History as HistoryIcon,
} from 'lucide-react';
import { User } from '../../types';
import { Button } from '../ui/button';
import { Slider } from '../ui/slider';
import { api } from '@/lib/unifiedApi';
import { useWithReconcile } from '@/lib/sync';
import { useUserGold } from '@/hooks/useSelectors';
import { useGlobalStore, mergeProfile } from '@/store/globalStore';
import { useGlobalSync } from '@/hooks/useGlobalSync';
import { useGameTileStats } from '@/hooks/useGameStats';

interface NeonCrashGameProps {
  user: User;
  onBack: () => void;
  onUpdateUser: (user: User) => void;
  onAddNotification: (message: string) => void;
}

export function NeonCrashGame({
  user,
  onBack,
  onUpdateUser,
  onAddNotification,
}: NeonCrashGameProps) {
  const crashStats = useGameTileStats('crash', user.gameStats?.crash);
  const withReconcile = useWithReconcile();
  const gold = useUserGold();
  const { dispatch } = useGlobalStore();
  const { syncAfterGame } = useGlobalSync();
  const [betAmount, setBetAmount] = useState(10);
  const [multiplier, setMultiplier] = useState(1.0);
  const [isRunning, setIsRunning] = useState(false);
  const [hasCashedOut, setHasCashedOut] = useState(false);
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [autoCashout, setAutoCashout] = useState(0);
  const [gameHistory, setGameHistory] = useState(
    [] as Array<{ multiplier: number; win: boolean; amount: number }>
  );
  const [lastCrashMultipliers, setLastCrashMultipliers] = useState([] as number[]);
  const [winAmount, setWinAmount] = useState(0);
  const [showGraph, setShowGraph] = useState(true);
  const [gameDataPoints, setGameDataPoints] = useState([] as Array<{ x: number; y: number }>);
  const [lastGameCurve, setLastGameCurve] = useState([] as Array<{ x: number; y: number }>);
  const [manualAutoCashout, setManualAutoCashout] = useState(2.0 as number);
  const [showAdvancedSettings, setShowAdvancedSettings] = useState(false);
  const [graphTimeScale, setGraphTimeScale] = useState(10); // Í∑∏ÎûòÌîÑ ÏãúÍ∞Ñ Ïä§ÏºÄÏùº (Ï¥à)
  const [gameStartTime, setGameStartTime] = useState(0);
  // Ïò§Î•ò ÏÉÅÌÉú Î∞è Ïû¨ÏãúÎèÑ Ìä∏Î¶¨Í±∞
  const [errorMessage, setErrorMessage] = useState(null as string | null);
  const [retryKey, setRetryKey] = useState(0);

  // Canvas Î∞è Ïï†ÎãàÎ©îÏù¥ÏÖò Í¥ÄÎ†® Refs
  const canvasRef = useRef(null) as { current: HTMLCanvasElement | null };
  const animationRef = useRef(null) as { current: number | null };
  const lastTimestamp = useRef(null) as { current: number | null };

  // ÏÑúÎ≤Ñ Í∂åÏúÑ GameStats (crash) - /games/stats/me
  const [authoritativeStats, setAuthoritativeStats] = useState(
    null as null | {
      total_bets: number;
      total_wins: number;
      total_losses: number;
      total_profit: number;
      highest_multiplier: number | null;
    }
  );
  const fetchAuthoritativeStats = useCallback(async () => {
    try {
      // Unified API: omit '/api' prefix
      const res = await api.get<any>('games/stats/me');
      if (res?.success && res.stats) {
        setAuthoritativeStats({
          total_bets: res.stats.total_bets ?? 0,
          total_wins: res.stats.total_wins ?? 0,
          total_losses: res.stats.total_losses ?? 0,
          total_profit: res.stats.total_profit ?? 0,
          highest_multiplier: res.stats.highest_multiplier ?? null,
        });
      }
    } catch (e) {
      console.warn('authoritative stats fetch Ïã§Ìå®', e);
    }
  }, []);
  useEffect(() => {
    fetchAuthoritativeStats();
  }, [fetchAuthoritativeStats]);

  // Í≤åÏûÑ ÏãúÏûë - ÏÑúÎ≤ÑÏóêÏÑú Ïã§Ï†ú Î≤†ÌåÖ Ï≤òÎ¶¨ (ÏÑúÎ≤Ñ Í∂åÏúÑ; withReconcileÎ°ú Î©±Îì±+Ïû¨ÎèôÍ∏∞Ìôî)
  const startGame = async () => {
    if (gold < betAmount) {
      onAddNotification('Î≤†ÌåÖÌï† Í≥®ÎìúÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.');
      return;
    }

    // Í≤åÏûÑÏù¥ Ïù¥ÎØ∏ Ïã§Ìñâ Ï§ëÏù¥Î©¥ Ï§ëÎ≥µ ÏãúÏûë Î∞©ÏßÄ
    if (isRunning) {
      return;
    }

    try {
      // Ïù¥Ï†Ñ Ïò§Î•ò ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      setErrorMessage(null);
      // ÏÑúÎ≤ÑÏóê ÌÅ¨ÎûòÏãú Î≤†ÌåÖ ÏöîÏ≤≠ (Î©±Îì±ÌÇ§ Ìè¨Ìï®)
      const gameResult = await withReconcile(async (idemKey: string) =>
        api.post<any>(
          'games/crash/bet',
          {
            bet_amount: betAmount,
            auto_cashout_multiplier:
              showAdvancedSettings && manualAutoCashout > 0 ? manualAutoCashout : null,
          },
          { headers: { 'X-Idempotency-Key': idemKey } }
        )
      );

      // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í≤åÏûÑ Í≤∞Í≥ºÎ°ú Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
      const finalMultiplier = gameResult.max_multiplier || 1.01;
      const winAmount = gameResult.win_amount || 0;
      const newBalance = gameResult?.balance ?? gameResult?.gold ?? gameResult?.gold_balance;
      if (typeof newBalance === 'number' && Number.isFinite(newBalance)) {
        mergeProfile(dispatch, { goldBalance: Number(newBalance) });
      }
      const isWin = gameResult.status === 'auto_cashed';

      // Ïù¥Ï†Ñ Í≤åÏûÑÏùò Í≥°ÏÑ† Ï†ÄÏû•
      if (gameDataPoints.length > 0) {
        setLastGameCurve([...gameDataPoints]);
      }

      // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
      setMultiplier(1.0);
      setIsRunning(true);
      setHasCashedOut(isWin);
      setWinAmount(winAmount);
      setGameDataPoints([]);

      // ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ ÏÑ§Ï†ï
      if (showAdvancedSettings && manualAutoCashout > 0) {
        setAutoCashout(manualAutoCashout);
      }

      // Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ ÏúÑÌï¥ Î™©Ìëú Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ ÏÑ§Ï†ï
      window._crashGameTarget = finalMultiplier;
      window._crashGameWin = winAmount;
      window._crashGameIsWin = isWin;

      // Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
      lastTimestamp.current = performance.now();
      animationRef.current = requestAnimationFrame(updateGame);

      // ÌÜµÍ≥ÑÎäî Î≥ÑÎèÑ fetch, ÏûîÏï°ÏùÄ withReconcile ÌõÑ ÌïòÏù¥ÎìúÎ†àÏù¥Ìä∏Ïóê ÏúÑÏûÑ
      // üéØ Ï§ëÏöî: mergeGameStats Ï†úÍ±∞ - ÎàÑÏ†Å Î≤ÑÍ∑∏ Î∞©ÏßÄ, ÏÑúÎ≤Ñ Í∂åÏúÑ ÎèôÍ∏∞ÌôîÎßå ÏÇ¨Ïö©
      // mergeGameStats(dispatch, 'crash', { ... }); // Ï†úÍ±∞Îê®
      
      // ÏÑúÎ≤ÑÏûîÏï° Ìè¨Ìï®ÎêòÏóàÎçîÎùºÎèÑ ÌõÑÏ≤òÎ¶¨ Ïä§ÎÉÖÏÉ∑ ÎèôÍ∏∞Ìôî
      await syncAfterGame();
      fetchAuthoritativeStats();
    } catch (error) {
      console.error('ÌÅ¨ÎûòÏãú Í≤åÏûÑ ÏãúÏûë Ïã§Ìå®:', error);
      const raw = (error as any)?.message || (typeof error === 'string' ? (error as string) : '');
      // ÏÑúÎ≤Ñ ÌëúÏ§Ä ÏóêÎü¨ Ìè¨Îß∑ÏùÑ UX Î©îÏãúÏßÄÎ°ú Îß§Ìïë
      const isServer500 = /HTTP_500|500\s+Internal|ÌÅ¨ÎûòÏãú Î≤†ÌåÖ Ï≤òÎ¶¨ Ïò§Î•ò/.test(raw);
      const userMsg = isServer500
        ? 'ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÎ°ú Î≤†ÌåÖÏùÑ Ï≤òÎ¶¨ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'
        : 'Í≤åÏûÑ ÏãúÏûëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
      setErrorMessage(userMsg);
      onAddNotification(userMsg);
      // Î∂ÄÎ∂ÑÏ†ÅÏúºÎ°ú Ï¶ùÍ∞ÄÌïú Î°úÏª¨ ÏÉÅÌÉúÍ∞Ä ÏûàÏúºÎ©¥ ÎêòÎèåÎ¶º(Ïã§Ìñâ ÌîåÎûòÍ∑∏ Îì±)
      setIsRunning(false);
      setHasCashedOut(false);
    }
  };

  // ÏÑúÎ≤Ñ/ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïù¥Îìú Î†åÎçîÎßÅÏùÑ ÏúÑÌïú ÏïàÏ†ÑÌïú ÎÇúÏàò ÏÉùÏÑ±Í∏∞
  const getRandomValue = useCallback(() => {
    // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïù¥ÎìúÏóêÏÑúÎßå Math.random() ÏÇ¨Ïö©
    if (typeof window !== 'undefined') {
      return Math.random();
    }
    // ÏÑúÎ≤Ñ ÏÇ¨Ïù¥ÎìúÏóêÏÑúÎäî Í≥†Ï†ïÎêú Í∞í Î∞òÌôò
    return 0.5;
  }, []);

  // Í∑∏ÎûòÌîÑ Í∑∏Î¶¨Í∏∞ Ìï®Ïàò
  const drawGraph = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    // Ï∫îÎ≤ÑÏä§ Ìï¥ÏÉÅÎèÑ ÏÑ§Ï†ï
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();

    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);

    // Ï∫îÎ≤ÑÏä§ Ï¥àÍ∏∞Ìôî
    ctx.clearRect(0, 0, rect.width, rect.height);

    // Í≤©Ïûê Í∑∏Î¶¨Í∏∞
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.lineWidth = 1;

    // Í∞ÄÎ°ú Í≤©Ïûê
    for (let i = 0; i <= 5; i++) {
      const y = rect.height - (rect.height / 5) * i;
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(rect.width, y);
      ctx.stroke();

      // Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ ÏàòÏπò ÌëúÏãú (Ïò§Î•∏Ï™ΩÏóê)
      if (i > 0) {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.font = '10px Inter';
        ctx.textAlign = 'right';
        ctx.fillText(`${i}x`, rect.width - 5, y - 5);
      }
    }

    // ÏÑ∏Î°ú Í≤©Ïûê
    for (let i = 0; i <= 5; i++) {
      const x = (rect.width / 5) * i;
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, rect.height);
      ctx.stroke();

      // ÏãúÍ∞Ñ ÌëúÏãú (ÏïÑÎûòÏóê)
      if (i > 0 && i < 5) {
        ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
        ctx.font = '10px Inter';
        ctx.textAlign = 'center';
        ctx.fillText(`${Math.round((i / 5) * graphTimeScale)}s`, x, rect.height - 5);
      }
    }

    // Ïù¥Ï†Ñ Í≤åÏûÑ Í≥°ÏÑ† Í∑∏Î¶¨Í∏∞ (ÌöåÏÉâÏúºÎ°ú ÌëúÏãú)
    if (lastGameCurve.length > 1) {
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.lineWidth = 2;
      ctx.beginPath();

      lastGameCurve.forEach((point: { x: number; y: number }, index: number) => {
        const x = (point.x / graphTimeScale) * rect.width;
        const y = rect.height - (point.y / 5) * rect.height;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();
    }

    // ÌòÑÏû¨ Í≤åÏûÑ Í≥°ÏÑ† Í∑∏Î¶¨Í∏∞
    if (gameDataPoints.length > 1) {
      // ÎÑ§Ïò® Ìö®Í≥ºÎ•º ÏúÑÌïú Í∑∏ÎùºÎç∞Ïù¥ÏÖò
      const gradient = ctx.createLinearGradient(0, 0, 0, rect.height);
      gradient.addColorStop(0, '#ff0066');
      gradient.addColorStop(1, '#00ffff');

      ctx.strokeStyle = gradient;
      ctx.lineWidth = 3;
      ctx.beginPath();

      gameDataPoints.forEach((point: { x: number; y: number }, index: number) => {
        const x = (point.x / graphTimeScale) * rect.width;
        const y = rect.height - (point.y / 5) * rect.height;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();

      // ÎßàÏßÄÎßâ Ìè¨Ïù∏Ìä∏Ïóê Ïõê ÌëúÏãú
      if (gameDataPoints.length > 0) {
        const lastPoint = gameDataPoints[gameDataPoints.length - 1];
        const x = (lastPoint.x / graphTimeScale) * rect.width;
        const y = rect.height - (lastPoint.y / 5) * rect.height;

        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#ff0066';
        ctx.fill();
      }
    }
  }, [gameDataPoints, lastGameCurve, graphTimeScale]);

  // Í≤åÏûÑ ÏãúÏûë Ïãú Í∑∏ÎûòÌîÑ Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    if (isRunning && showGraph) {
      drawGraph();
    }
  }, [isRunning, showGraph, drawGraph]);

  // Í≤åÏûÑ ÏóÖÎç∞Ïù¥Ìä∏ (Ïï†ÎãàÎ©îÏù¥ÏÖò ÌîÑÎ†àÏûÑ)
  const updateGame = useCallback(
    (timestamp: number) => {
      if (!lastTimestamp.current) {
        lastTimestamp.current = timestamp;
        setGameStartTime(timestamp);
        animationRef.current = requestAnimationFrame(updateGame);
        return;
      }

      const elapsed = timestamp - lastTimestamp.current;
      lastTimestamp.current = timestamp;

      // Í≤åÏûÑ ÏãúÏûë Ïù¥ÌõÑ Í≤ΩÍ≥º ÏãúÍ∞Ñ (Ï¥à)
      const elapsedGameTime = (timestamp - gameStartTime) / 1000;

      // Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏ (Î°úÍ∑∏ Í≥°ÏÑ†ÏúºÎ°ú Ï¶ùÍ∞Ä)
      const growth = 1 + Math.log(multiplier) * 0.02;
      const newMultiplier = multiplier + growth * elapsed * 0.001;

      // Îç∞Ïù¥ÌÑ∞ Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä (10ÌîÑÎ†àÏûÑÎßàÎã§ ÌïúÎ≤à)
      if (gameDataPoints.length === 0 || gameDataPoints.length % 10 === 0) {
        setGameDataPoints((prev: Array<{ x: number; y: number }>) => [
          ...prev,
          { x: elapsedGameTime, y: newMultiplier },
        ]);
      }

      // Í∑∏ÎûòÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
      if (showGraph && canvasRef.current) {
        drawGraph();
      }

      // ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ Ï≤¥ÌÅ¨
      if (autoCashout > 0 && newMultiplier >= autoCashout && !hasCashedOut) {
        void cashout();
      }

      // Ìè≠Î∞ú Ï≤¥ÌÅ¨ (ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Î™©Ìëú Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ ÏÇ¨Ïö©)
      const targetMultiplier = (window as any)._crashGameTarget || 1.5;
      if (newMultiplier >= targetMultiplier) {
        gameCrashed(targetMultiplier);
        return;
      }

      setMultiplier(newMultiplier);
      animationRef.current = requestAnimationFrame(updateGame);
    },
    [
      multiplier,
      hasCashedOut,
      autoCashout,
      betAmount,
      gameStartTime,
      gameDataPoints,
      showGraph,
      drawGraph,
    ]
  );

  // Í≤åÏûÑ Ï∫êÏãúÏïÑÏõÉ (ÏÑúÎ≤Ñ Í∂åÏúÑ; withReconcileÎ°ú Ïû¨ÎèôÍ∏∞Ìôî)
  const cashout = async () => {
    if (!isRunning || hasCashedOut) return;

    // Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ïÏßÄ
    if (animationRef.current) {
      cancelAnimationFrame(animationRef.current);
    }

    // ÌöçÎìù Í∏àÏï° Í≥ÑÏÇ∞
    const winnings = Math.floor(betAmount * multiplier);
    setWinAmount(winnings);

    // ÏÑúÎ≤ÑÏóê Ï∫êÏãúÏïÑÏõÉ ÏöîÏ≤≠(ÌïÑÏöî Ïãú). ÌòÑÏû¨ Î∞±ÏóîÎìúÏóê Î≥ÑÎèÑ Ï∫êÏãúÏïÑÏõÉ ÏóîÎìúÌè¨Ïù∏Ìä∏Í∞Ä Ï°¥Ïû¨ÌïòÎ©¥ ÏÇ¨Ïö©
    try {
      console.log('[NeonCrashGame] Ï∫êÏãúÏïÑÏõÉ ÏöîÏ≤≠ ÏãúÏûë:', {
        multiplier,
        game_id: 'crash',
        endpoint: 'games/crash/cashout'
      });
      
      // Ïö∞ÏÑ† Î©±Îì±+Ïû¨ÎèôÍ∏∞ÌôîÎßå ÏàòÌñâÌïòÏó¨ ÏµúÏ¢Ö ÏûîÏï° ÏùºÏπò Î≥¥Ïû•
      await withReconcile(async (idemKey: string) =>
        api.post<any>(
          'games/crash/cashout',
          { multiplier, game_id: 'crash' },
          { headers: { 'X-Idempotency-Key': idemKey } }
        )
      );
      
      console.log('[NeonCrashGame] Ï∫êÏãúÏïÑÏõÉ ÏöîÏ≤≠ ÏÑ±Í≥µ');
    } catch (e) {
      console.error('[NeonCrashGame] Ï∫êÏãúÏïÑÏõÉ ÏöîÏ≤≠ Ïã§Ìå®:', e);
      // Ï∫êÏãúÏïÑÏõÉ Ïã§Ìå® Ïãú Ïò§Î•ò ÌëúÏãú + Ïû¨ÏãúÎèÑ Ïú†ÎèÑ
      const msg =
        (e as any)?.message ||
        (typeof e === 'string' ? (e as string) : 'Ï∫êÏãúÏïÑÏõÉ Ï≤òÎ¶¨Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
      setErrorMessage(msg);
    }

    // Í≤åÏûÑ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    setHasCashedOut(true);
    setIsRunning(false);

    // Í≤åÏûÑ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
    setGameHistory((prev: Array<{ multiplier: number; win: boolean; amount: number }>) => [
      {
        multiplier: multiplier,
        win: true,
        amount: winnings,
      },
      ...prev,
    ]);

    // üéØ Ï§ëÏöî: mergeGameStats Ï†úÍ±∞ - ÎàÑÏ†Å Î≤ÑÍ∑∏ Î∞©ÏßÄ, ÏÑúÎ≤Ñ Í∂åÏúÑ ÎèôÍ∏∞ÌôîÎßå ÏÇ¨Ïö©
    // mergeGameStats(dispatch, 'crash', { ... }); // Ï†úÍ±∞Îê®

    await syncAfterGame();
    fetchAuthoritativeStats();

    // ÏïåÎ¶º
    onAddNotification(`${winnings} Í≥®ÎìúÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§! (${multiplier.toFixed(2)}x)`);
  };

  // Í≤åÏûÑ Ï¢ÖÎ£å (ÌÅ¨ÎûòÏãú ÎòêÎäî ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ)
  const gameCrashed = (finalMultiplier: number) => {
    if (animationRef.current) {
      cancelAnimationFrame(animationRef.current);
    }

    // ÏµúÍ∑º Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ ÏóÖÎç∞Ïù¥Ìä∏
    setLastCrashMultipliers((prev: number[]) => [finalMultiplier, ...prev].slice(0, 5));

    // ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ Í≤åÏûÑ Í≤∞Í≥º ÌôïÏù∏
    const isWin = (window as any)._crashGameIsWin || false;
    const serverWinAmount = (window as any)._crashGameWin || 0;

    if (isWin && serverWinAmount > 0) {
      // ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ ÏÑ±Í≥µ
      setGameHistory((prev: Array<{ multiplier: number; win: boolean; amount: number }>) => [
        {
          multiplier: finalMultiplier,
          win: true,
          amount: serverWinAmount,
        },
        ...prev,
      ]);

      fetchAuthoritativeStats();

      onAddNotification(
        `ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ! ${serverWinAmount} Í≥®ÎìúÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§! (${finalMultiplier.toFixed(2)}x)`
      );
      setWinAmount(serverWinAmount);
      setHasCashedOut(true);
    } else {
      // ÌÅ¨ÎûòÏãú (Ìå®Î∞∞)
      if (!hasCashedOut) {
        setGameHistory((prev: Array<{ multiplier: number; win: boolean; amount: number }>) => [
          {
            multiplier: finalMultiplier,
            win: false,
            amount: -betAmount,
          },
          ...prev,
        ]);

  void syncAfterGame();
  fetchAuthoritativeStats();

        onAddNotification(`ÌÅ¨ÎûòÏãú! ${finalMultiplier.toFixed(2)}xÏóêÏÑú ÌÑ∞Ï°åÏäµÎãàÎã§.`);
      }
    }

    // Í≤åÏûÑ Ï¢ÖÎ£å
    setIsRunning(false);

    // Ï†ÑÏó≠ Î≥ÄÏàò Ï†ïÎ¶¨
    delete (window as any)._crashGameTarget;
    delete (window as any)._crashGameWin;
    delete (window as any)._crashGameIsWin;
  };

  // Î≤†ÌåÖ Í∏àÏï° Î≥ÄÍ≤Ω
  const changeBetAmount = (amount: number) => {
    if (!isRunning) {
      setBetAmount(Math.max(1, amount));
    }
  };

  // ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ ÏÑ§Ï†ï
  const changeAutoCashout = (value: number) => {
    if (!isRunning) {
      setAutoCashout(value);
    }
  };

  // ÏÜåÎ¶¨ ÏÑ§Ï†ï ÌÜ†Í∏Ä
  const toggleSound = () => {
    setSoundEnabled(!soundEnabled);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-background via-black to-error/10 relative overflow-hidden">
      {/* ÎèôÏ†Å Î∞∞Í≤Ω */}
      <motion.div
        animate={{
          background: isRunning
            ? 'radial-gradient(circle, rgba(255,0,68,0.05) 0%, rgba(0,0,0,0) 70%)'
            : 'radial-gradient(circle, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 100%)',
        }}
        transition={{ duration: 0.5 }}
        className="absolute inset-0 z-0 pointer-events-none"
      />

      {/* Ìó§Îçî */}
      <motion.header
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="p-4 flex items-center justify-between"
      >
        <div className="flex items-center space-x-2">
          <Button variant="ghost" size="icon" onClick={onBack} className="rounded-full" aria-label="Îí§Î°úÍ∞ÄÍ∏∞">
            <ArrowLeft className="h-6 w-6" />
          </Button>
          <h1 className="text-2xl font-bold text-gradient-primary">ÎÑ§Ïò® ÌÅ¨ÎûòÏãú</h1>
        </div>

        <div className="flex items-center space-x-4">
          <Button variant="ghost" size="icon" onClick={toggleSound} className="rounded-full" aria-label="ÏÇ¨Ïö¥Îìú ÌÜ†Í∏Ä">
            {soundEnabled ? <Volume2 className="h-6 w-6" /> : <VolumeX className="h-6 w-6" />}
          </Button>
          <Button
            variant="ghost"
            size="icon"
            onClick={() => setShowGraph(!showGraph)}
            className="rounded-full"
            aria-label="Í∑∏ÎûòÌîÑ ÌëúÏãú ÌÜ†Í∏Ä"
          >
            <BarChart2
              className={`h-6 w-6 ${showGraph ? 'text-primary' : 'text-muted-foreground'}`}
            />
          </Button>
          <Button
            variant="ghost"
            size="icon"
            onClick={() => setShowAdvancedSettings(!showAdvancedSettings)}
            className="rounded-full"
            aria-label="Í≥†Í∏â ÏÑ§Ï†ï Ïó¥Í∏∞"
          >
            <Settings
              className={`h-6 w-6 ${
                showAdvancedSettings ? 'text-primary' : 'text-muted-foreground'
              }`}
            />
          </Button>
          <div className="text-xl font-bold">{gold.toLocaleString()} G</div>
        </div>
      </motion.header>

      {/* Î©îÏù∏ ÏΩòÌÖêÏ∏† */}
      <div className="max-w-6xl mx-auto px-4 py-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Í≤åÏûÑ ÌôîÎ©¥ (ÏôºÏ™Ω 2/3) */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
          className="lg:col-span-2 glass-effect rounded-2xl overflow-hidden p-6 flex flex-col"
        >
          {/* Í≤åÏûÑ ÏòÅÏó≠ */}
          <div className="flex-1 flex flex-col items-center justify-center py-4 relative w-full">
            {errorMessage && (
              <div className="w-full max-w-xl mb-4 bg-destructive/15 border border-destructive/40 text-destructive px-4 py-3 rounded-lg shadow-sm animate-in fade-in">
                <div className="flex justify-between items-start gap-4">
                  <div className="flex-1">
                    <div className="font-semibold mb-1">Ïò§Î•ò Î∞úÏÉù</div>
                    <div className="text-sm leading-relaxed break-all">{errorMessage}</div>
                  </div>
                  <div className="flex gap-2 shrink-0">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => {
                        setRetryKey((k: number) => k + 1);
                        void startGame();
                      }}
                    >
                      Ïû¨ÏãúÎèÑ
                    </Button>
                    <Button size="sm" variant="ghost" onClick={() => setErrorMessage(null)}>
                      Îã´Í∏∞
                    </Button>
                  </div>
                </div>
              </div>
            )}
            {/* Í∑∏ÎûòÌîÑ ÏòÅÏó≠ */}
            {showGraph && (
              <div className="w-full h-60 sm:h-72 md:h-80 mb-6 bg-background/30 rounded-lg p-3 border border-border/50 relative">
                <canvas ref={canvasRef} className="w-full h-full" style={{ touchAction: 'none' }} />

                {/* Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ Ïò§Î≤ÑÎ†àÏù¥ - Í∑∏ÎûòÌîÑ ÏúÑÏóê ÌÅ∞ Ïà´ÏûêÎ°ú ÌëúÏãú */}
                {isRunning && (
                  <motion.div
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"
                  >
                    <motion.div
                      animate={{
                        scale: [1, 1.05, 1],
                        color: multiplier > 2 ? ['#ffffff', '#ff5555', '#ff0000'] : '#ffffff',
                      }}
                      transition={{
                        repeat: Infinity,
                        duration: 1.5,
                      }}
                      className="text-5xl sm:text-7xl font-bold text-center"
                      style={{
                        textShadow:
                          '0 0 10px rgba(255, 0, 102, 0.7), 0 0 20px rgba(255, 0, 102, 0.5)',
                      }}
                    >
                      {multiplier.toFixed(2)}x
                    </motion.div>
                  </motion.div>
                )}

                {/* Í∑∏ÎûòÌîÑ ÏÑ§Ï†ï Î≤ÑÌäº */}
                <div className="absolute bottom-3 right-3 flex space-x-2">
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-8 w-8 rounded-full p-0 bg-background/50"
                    onClick={() => setGraphTimeScale(Math.max(5, graphTimeScale - 5))}
                    disabled={isRunning}
                  >
                    <ChevronDown className="h-4 w-4" />
                  </Button>
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-8 w-8 rounded-full p-0 bg-background/50"
                    onClick={() => setGraphTimeScale(graphTimeScale + 5)}
                    disabled={isRunning}
                  >
                    <ChevronUp className="h-4 w-4" />
                  </Button>
                </div>
              </div>
            )}

            {/* Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ ÌëúÏãú - Í∑∏ÎûòÌîÑ ÏóÜÏùÑ ÎïåÎßå ÌÅ∞ Ïà´ÏûêÎ°ú ÌëúÏãú */}
            {!showGraph && (
              <motion.div
                animate={{
                  scale: isRunning ? [1, 1.05, 1] : 1,
                  color:
                    isRunning && multiplier > 2 ? ['#ffffff', '#ff5555', '#ff0000'] : '#ffffff',
                }}
                transition={{
                  repeat: isRunning ? Infinity : 0,
                  duration: 1.5,
                }}
                className="text-7xl md:text-9xl font-bold text-center mb-6"
              >
                {multiplier.toFixed(2)}x
              </motion.div>
            )}

            {/* ÏµúÍ∑º Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥ Î™©Î°ù */}
            <div className="flex space-x-2 my-4 justify-center">
              {lastCrashMultipliers.map((crash: number, index: number) => (
                <div
                  key={index}
                  className={`rounded-md px-3 py-1 text-sm ${
                    crash > 2 ? 'bg-success/20 text-success' : 'bg-error/20 text-error'
                  }`}
                >
                  <div className="text-sm font-bold">{crash.toFixed(2)}x</div>
                </div>
              ))}
            </div>

            {/* Í≥†Í∏â ÏÑ§Ï†ï ÏòÅÏó≠ */}
            <AnimatePresence>
              {showAdvancedSettings && (
                <motion.div
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: 'auto' }}
                  exit={{ opacity: 0, height: 0 }}
                  transition={{ duration: 0.3 }}
                  className="w-full max-w-md bg-background/30 rounded-lg p-4 mb-4 overflow-hidden"
                >
                  <h4 className="text-sm font-semibold mb-3 flex items-center justify-between">
                    <span className="flex items-center">
                      <Settings className="w-4 h-4 mr-2 text-primary" />
                      Í≥†Í∏â ÏÑ§Ï†ï
                    </span>
                    <Button
                      variant="ghost"
                      size="sm"
                      className="h-7 w-7 rounded-full p-0"
                      onClick={() => setShowAdvancedSettings(false)}
                    >
                      <ChevronUp className="h-4 w-4" />
                    </Button>
                  </h4>

                  {/* ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ Ïä¨ÎùºÏù¥Îçî */}
                  <div className="space-y-3">
                    <div className="flex justify-between items-center">
                      <label className="text-xs text-muted-foreground">
                        ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ Î©ÄÌã∞ÌîåÎùºÏù¥Ïñ¥
                      </label>
                      <div className="text-xs font-medium">{manualAutoCashout.toFixed(2)}x</div>
                    </div>
                    <Slider
                      min={1.01}
                      max={10}
                      step={0.01}
                      value={[manualAutoCashout]}
                      onValueChange={(values: number[]) => setManualAutoCashout(values[0])}
                      disabled={isRunning}
                      className="py-2"
                    />
                    <div className="flex justify-between text-xs text-muted-foreground">
                      <span>1.01x</span>
                      <span>10.00x</span>
                    </div>
                  </div>

                  <div className="flex items-center justify-between mt-4">
                    <span className="text-xs text-muted-foreground">ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ Ï†ÅÏö©</span>
                    <Button
                      variant={autoCashout > 0 ? 'default' : 'outline'}
                      size="sm"
                      onClick={() => changeAutoCashout(autoCashout > 0 ? 0 : manualAutoCashout)}
                      disabled={isRunning}
                      className="h-7 min-w-[80px]"
                    >
                      {autoCashout > 0 ? 'ÏºúÏßê' : 'Í∫ºÏßê'}
                    </Button>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>

            {/* Í≤åÏûÑ Ïª®Ìä∏Î°§ */}
            <div className="w-full max-w-md mt-3 space-y-4">
              {/* Î≤†ÌåÖ Í∏àÏï° ÏÑ§Ï†ï */}
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <label className="text-sm text-muted-foreground">Î≤†ÌåÖ Í∏àÏï°</label>
                  <div className="text-sm font-medium">{betAmount} G</div>
                </div>

                {/* Ïä¨ÎùºÏù¥Îçî Ï∂îÍ∞Ä */}
                <div className="py-2 px-1">
                  <Slider
                    min={1}
                    max={Math.min(gold, 1000)}
                    step={1}
                    value={[betAmount]}
                    onValueChange={(values: number[]) => changeBetAmount(values[0])}
                    disabled={isRunning}
                    className="my-2"
                  />
                </div>

                <div className="flex space-x-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeBetAmount(Math.max(1, betAmount - 10))}
                    disabled={isRunning}
                  >
                    -10
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeBetAmount(Math.max(1, betAmount - 50))}
                    disabled={isRunning}
                  >
                    -50
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeBetAmount(betAmount + 10)}
                    disabled={isRunning}
                  >
                    +10
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeBetAmount(betAmount + 50)}
                    disabled={isRunning}
                  >
                    +50
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeBetAmount(betAmount * 2)}
                    disabled={isRunning}
                  >
                    x2
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeBetAmount(Math.floor(betAmount / 2))}
                    disabled={isRunning}
                  >
                    /2
                  </Button>
                </div>
              </div>

              {/* ÌÄµ ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ ÏÑ§Ï†ï */}
              <div className="space-y-2">
                <div className="flex justify-between items-center">
                  <label className="text-sm text-muted-foreground">ÏûêÎèô Ï∫êÏãúÏïÑÏõÉ</label>
                  <div className="text-sm font-medium">
                    {autoCashout > 0 ? `${autoCashout.toFixed(2)}x` : 'ÏóÜÏùå'}
                  </div>
                </div>
                <div className="flex flex-wrap gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeAutoCashout(0)}
                    disabled={isRunning}
                    className={autoCashout === 0 ? 'bg-primary/20' : ''}
                  >
                    ÏóÜÏùå
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeAutoCashout(1.5)}
                    disabled={isRunning}
                    className={autoCashout === 1.5 ? 'bg-primary/20' : ''}
                  >
                    1.5x
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeAutoCashout(2.0)}
                    disabled={isRunning}
                    className={autoCashout === 2.0 ? 'bg-primary/20' : ''}
                  >
                    2.0x
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeAutoCashout(5.0)}
                    disabled={isRunning}
                    className={autoCashout === 5.0 ? 'bg-primary/20' : ''}
                  >
                    5.0x
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => changeAutoCashout(10.0)}
                    disabled={isRunning}
                    className={autoCashout === 10.0 ? 'bg-primary/20' : ''}
                  >
                    10.0x
                  </Button>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => setShowAdvancedSettings(true)}
                    disabled={isRunning}
                    className="bg-background/50"
                  >
                    <Settings className="h-4 w-4 mr-1" />
                    Ïª§Ïä§ÌÖÄ
                  </Button>
                </div>
              </div>

              {/* Í≤åÏûÑ Î≤ÑÌäº */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                {!isRunning ? (
                  <Button
                    size="lg"
                    className="bg-primary text-white hover:bg-primary/80 h-14 rounded-xl text-lg font-bold"
                    onClick={startGame}
                    disabled={gold < betAmount}
                  >
                    <TrendingUp className="w-5 h-5 mr-2" />
                    Í≤åÏûÑ ÏãúÏûë
                  </Button>
                ) : (
                  <Button
                    size="lg"
                    className="bg-success text-white hover:bg-success/80 h-14 rounded-xl text-lg font-bold animate-pulse"
                    onClick={cashout}
                    disabled={hasCashedOut}
                  >
                    <DollarSign className="w-5 h-5 mr-2" />
                    Ï∫êÏãúÏïÑÏõÉ ({Math.floor(betAmount * multiplier)} G)
                  </Button>
                )}

                {winAmount > 0 && (
                  <motion.div
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="flex items-center justify-center h-14 rounded-xl bg-success/20 text-success text-lg font-bold"
                  >
                    <Zap className="w-5 h-5 mr-2" />
                    ÌöçÎìù: {winAmount} G
                  </motion.div>
                )}
              </div>
            </div>
          </div>
        </motion.div>

        {/* ÏÇ¨Ïù¥Îìú Ìå®ÎÑê (Ïò§Î•∏Ï™Ω 1/3) */}
        <div className="space-y-6">
          {/* ÏµúÍ∑º Í≤åÏûÑ Í∏∞Î°ù */}
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
            className="glass-effect rounded-xl p-6"
          >
            <h3 className="text-lg font-bold text-foreground mb-4 flex items-center gap-2">
              {/* History ÎÑ§Ïù¥Ìã∞Î∏å Í∞ùÏ≤¥(Î∏åÎùºÏö∞Ï†Ä History)ÏôÄ Ï∂©Îèå Î∞©ÏßÄ ÏúÑÌï¥ HistoryIcon ÏÇ¨Ïö© */}
              <HistoryIcon className="w-5 h-5 text-primary" />
              ÏµúÍ∑º Í≤åÏûÑ Í∏∞Î°ù
            </h3>

            <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2">
              {gameHistory.length > 0 ? (
                gameHistory
                  .slice(0, 8)
                  .map(
                    (game: { multiplier: number; win: boolean; amount: number }, index: number) => (
                      <div
                        key={index}
                        className={`flex justify-between items-center p-3 rounded-lg ${
                          game.win
                            ? 'bg-success/10 border border-success/20'
                            : 'bg-error/10 border border-error/20'
                        }`}
                      >
                        <div className="flex flex-col">
                          <span className="font-medium">{game.multiplier.toFixed(2)}x</span>
                          <span className="text-xs text-muted-foreground">Î≤†ÌåÖ: {betAmount} G</span>
                        </div>
                        <div className={`font-bold ${game.win ? 'text-success' : 'text-error'}`}>
                          {game.win ? '+' : ''}
                          {game.amount}
                        </div>
                      </div>
                    )
                  )
              ) : (
                <div className="text-center text-muted-foreground py-4">Í≤åÏûÑ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§</div>
              )}
            </div>

            {gameHistory.length > 0 && (
              <div className="flex justify-end mt-3">
                <Button
                  variant="ghost"
                  size="sm"
                  className="text-xs text-muted-foreground"
                  onClick={() => setGameHistory([])}
                >
                  <RefreshCw className="h-3 w-3 mr-1" />
                  Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
                </Button>
              </div>
            )}
          </motion.div>
        </div>
      </div>
    </div>
  );
}
