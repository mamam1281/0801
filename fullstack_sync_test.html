<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í’€ìŠ¤íƒ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .success { border-color: #4CAF50; background: #1b2f1b; }
        .error { border-color: #f44336; background: #2f1b1b; }
        .warning { border-color: #ff9800; background: #2f1f1b; }
        button { padding: 10px 20px; margin: 5px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976D2; }
        button:disabled { background: #555; cursor: not-allowed; }
        pre { background: #333; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 300px; }
        .status { margin: 10px 0; padding: 5px; border-radius: 4px; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #555; background: #2a2a2a; color: #fff; border-radius: 4px; }
        .iframe-container { border: 2px solid #555; border-radius: 8px; margin: 10px 0; }
        iframe { width: 100%; height: 400px; border: none; border-radius: 6px; }
        .sync-indicator { 
            display: inline-block; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
            margin-right: 5px;
        }
        .sync-ok { background: #4CAF50; }
        .sync-error { background: #f44336; }
        .sync-warning { background: #ff9800; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .frontend-preview { border: 1px solid #444; border-radius: 8px; padding: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ”„ í’€ìŠ¤íƒ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ (ë°±ì—”ë“œ + í”„ë¡ íŠ¸ì—”ë“œ)</h1>
    
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ ëŒ€ì‹œë³´ë“œ -->
    <div class="section">
        <h2>ğŸ“Š ì‹¤ì‹œê°„ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
        <div id="system-status">
            <p><span class="sync-indicator sync-warning"></span>ë°±ì—”ë“œ: í™•ì¸ ì¤‘...</p>
            <p><span class="sync-indicator sync-warning"></span>í”„ë¡ íŠ¸ì—”ë“œ: í™•ì¸ ì¤‘...</p>
            <p><span class="sync-indicator sync-warning"></span>ë™ê¸°í™”: í™•ì¸ ì¤‘...</p>
        </div>
        <button onclick="refreshSystemStatus()">ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
        <button onclick="testWebSocketConnection()">WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <button onclick="startRealTimeMonitoring()">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button onclick="stopRealTimeMonitoring()">ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
    </div>

    <!-- í”„ë¡ íŠ¸ì—”ë“œ ì§ì ‘ í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h2>ğŸŒ í”„ë¡ íŠ¸ì—”ë“œ ì§ì ‘ í…ŒìŠ¤íŠ¸</h2>
        <div class="test-grid">
            <!-- ë°±ì—”ë“œ API í…ŒìŠ¤íŠ¸ -->
            <div>
                <h3>âš¡ ë°±ì—”ë“œ API</h3>
                <button onclick="testBackendLogin()">ë°±ì—”ë“œ ë¡œê·¸ì¸</button>
                <button onclick="testBackendShop()">ë°±ì—”ë“œ ìƒì </button>
                <button onclick="testBackendEvents()">ë°±ì—”ë“œ ì´ë²¤íŠ¸</button>
                <pre id="backend-result"></pre>
            </div>
            
            <!-- í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€ í…ŒìŠ¤íŠ¸ -->
            <div>
                <h3>ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€</h3>
                <button onclick="testFrontendLogin()">í”„ë¡ íŠ¸ ë¡œê·¸ì¸ í˜ì´ì§€</button>
                <button onclick="testFrontendShop()">í”„ë¡ íŠ¸ ìƒì  í˜ì´ì§€</button>
                <button onclick="testFrontendAdmin()">í”„ë¡ íŠ¸ ì–´ë“œë¯¼ í˜ì´ì§€</button>
                <pre id="frontend-result"></pre>
            </div>
        </div>
    </div>

    <!-- ë™ê¸°í™” ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ -->
    <div class="section">
        <h2>ğŸ”„ ë™ê¸°í™” ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸</h2>
        <div>
            <h3>ğŸ’° êµ¬ë§¤ â†’ ì”ì•¡ ë™ê¸°í™”</h3>
            <button onclick="runPurchaseSync()">êµ¬ë§¤ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
            <div class="sync-flow">
                <p>1. ë°±ì—”ë“œì—ì„œ êµ¬ë§¤ ì‹¤í–‰</p>
                <p>2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì”ì•¡ í™•ì¸</p>
                <p>3. WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ í™•ì¸</p>
            </div>
        </div>
        
        <div>
            <h3>ğŸ¯ ì´ë²¤íŠ¸ â†’ ë³´ìƒ ë™ê¸°í™”</h3>
            <button onclick="runEventSync()">ì´ë²¤íŠ¸ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
            <div class="sync-flow">
                <p>1. ë°±ì—”ë“œì—ì„œ ì´ë²¤íŠ¸ ì°¸ì—¬</p>
                <p>2. í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§„í–‰ìƒí™© í™•ì¸</p>
                <p>3. ë³´ìƒ ìˆ˜ë ¹ í›„ ë™ê¸°í™” í™•ì¸</p>
            </div>
        </div>
        
        <div>
            <h3>ğŸ‘‘ ì–´ë“œë¯¼ â†’ ì‚¬ìš©ì ë™ê¸°í™”</h3>
            <button onclick="runAdminSync()">ì–´ë“œë¯¼ ë™ê¸°í™” í…ŒìŠ¤íŠ¸</button>
            <div class="sync-flow">
                <p>1. ì–´ë“œë¯¼ì—ì„œ ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</p>
                <p>2. ì‚¬ìš©ì í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë³€ê²½ì‚¬í•­ í™•ì¸</p>
                <p>3. ì‹¤ì‹œê°„ ë°˜ì˜ ì—¬ë¶€ í™•ì¸</p>
            </div>
        </div>
        
        <div id="sync-status" class="status"></div>
        <pre id="sync-result"></pre>
    </div>

    <!-- í”„ë¡ íŠ¸ì—”ë“œ ì„ë² ë“œ í”„ë¦¬ë·° -->
    <div class="section">
        <h2>ğŸ‘€ í”„ë¡ íŠ¸ì—”ë“œ ì‹¤ì‹œê°„ í”„ë¦¬ë·°</h2>
        <div class="frontend-preview">
            <h3>ë©”ì¸ í˜ì´ì§€</h3>
            <iframe id="main-preview" src="http://localhost:3000"></iframe>
            <button onclick="refreshPreview('main-preview', 'http://localhost:3000')">ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="openInNewTab('http://localhost:3000')">ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</button>
        </div>
        
        <div class="frontend-preview">
            <h3>ìƒì  í˜ì´ì§€</h3>
            <iframe id="shop-preview" src="http://localhost:3000/shop"></iframe>
            <button onclick="refreshPreview('shop-preview', 'http://localhost:3000/shop')">ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="openInNewTab('http://localhost:3000/shop')">ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</button>
        </div>
        
        <div class="frontend-preview">
            <h3>ì–´ë“œë¯¼ í˜ì´ì§€</h3>
            <iframe id="admin-preview" src="http://localhost:3000/admin"></iframe>
            <button onclick="refreshPreview('admin-preview', 'http://localhost:3000/admin')">ìƒˆë¡œê³ ì¹¨</button>
            <button onclick="openInNewTab('http://localhost:3000/admin')">ìƒˆ íƒ­ì—ì„œ ì—´ê¸°</button>
        </div>
    </div>

    <!-- ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ -->
    <div class="section">
        <h2>ğŸš€ ì „ì²´ í’€ìŠ¤íƒ í…ŒìŠ¤íŠ¸</h2>
        <button onclick="runFullStackTest()" id="full-test-btn">ì „ì²´ í’€ìŠ¤íƒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
        <button onclick="runSyncDiagnosis()">ë™ê¸°í™” ë¬¸ì œ ì§„ë‹¨</button>
        <button onclick="exportTestResults()">í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
        
        <div id="full-test-progress" style="display: none;">
            <p>ğŸ”„ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘...</p>
            <div id="progress-details"></div>
        </div>
        
        <div id="full-test-status" class="status"></div>
        <pre id="full-test-result"></pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        const FRONTEND_BASE = 'http://localhost:3000';
        let authToken = null;
        let adminToken = null;
        let monitoringInterval = null;

        // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        async function refreshSystemStatus() {
            const statusEl = document.getElementById('system-status');
            if (!statusEl) {
                console.error('system-status ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // ë°±ì—”ë“œ ìƒíƒœ
            try {
                const backendResponse = await fetch(`${API_BASE}/health`);
                const backendStatus = backendResponse.ok ? 'sync-ok' : 'sync-error';
                if (statusEl.children[0]) {
                    statusEl.children[0].innerHTML = `<span class="sync-indicator ${backendStatus}"></span>ë°±ì—”ë“œ: ${backendResponse.ok ? 'ì •ìƒ' : 'ì˜¤ë¥˜'}`;
                }
            } catch (error) {
                if (statusEl.children[0]) {
                    statusEl.children[0].innerHTML = `<span class="sync-indicator sync-error"></span>ë°±ì—”ë“œ: ì—°ê²° ì‹¤íŒ¨`;
                }
            }
            
            // í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ
            try {
                console.log('Checking frontend health:', `${FRONTEND_BASE}/api/health`);
                const frontendResponse = await fetch(`${FRONTEND_BASE}/api/health`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                });
                console.log('Frontend health response:', frontendResponse.status, frontendResponse.ok);
                const frontendStatus = frontendResponse.ok ? 'sync-ok' : 'sync-warning';
                if (statusEl.children[1]) {
                    statusEl.children[1].innerHTML = `<span class="sync-indicator ${frontendStatus}"></span>í”„ë¡ íŠ¸ì—”ë“œ: ${frontendResponse.ok ? 'ì •ìƒ' : 'í™•ì¸ í•„ìš”'}`;
                }
            } catch (error) {
                console.log('Frontend health check failed:', error.message);
                // í”„ë¡ íŠ¸ì—”ë“œëŠ” í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ì„ ìˆ˜ ìˆìŒ
                try {
                    console.log('Trying frontend main page:', `${FRONTEND_BASE}/`);
                    const mainPageResponse = await fetch(`${FRONTEND_BASE}/`, { 
                        method: 'HEAD',
                        mode: 'cors',
                        redirect: 'manual'  // ë¦¬ë””ë ‰ì…˜ì„ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬
                    });
                    console.log('Frontend main page response:', mainPageResponse.status, mainPageResponse.type);
                    
                    // 200 OK ë˜ëŠ” 307 Redirect (ë¡œê·¸ì¸ í˜ì´ì§€)ë©´ ì •ìƒ ì‘ë™
                    const isWorking = mainPageResponse.ok || mainPageResponse.status === 307;
                    const frontendStatus = isWorking ? 'sync-ok' : 'sync-warning';
                    
                    let statusText = 'ì •ìƒ';
                    if (mainPageResponse.status === 307) {
                        statusText = 'ì •ìƒ (ë¡œê·¸ì¸ í•„ìš”)';
                    } else if (!mainPageResponse.ok) {
                        statusText = 'í™•ì¸ í•„ìš”';
                    }
                    
                    if (statusEl.children[1]) {
                        statusEl.children[1].innerHTML = `<span class="sync-indicator ${frontendStatus}"></span>í”„ë¡ íŠ¸ì—”ë“œ: ${statusText}`;
                    }
                } catch (error) {
                    console.log('Frontend main page check also failed:', error.message);
                    if (statusEl.children[1]) {
                        statusEl.children[1].innerHTML = `<span class="sync-indicator sync-error"></span>í”„ë¡ íŠ¸ì—”ë“œ: ì—°ê²° ì‹¤íŒ¨ (${error.message})`;
                    }
                }
            }
            
            // ë™ê¸°í™” ìƒíƒœ (API ê¸°ë°˜ ë™ê¸°í™” í™•ì¸)
            if (statusEl.children[2]) {
                // ë°±ì—”ë“œì™€ í”„ë¡ íŠ¸ì—”ë“œê°€ ëª¨ë‘ ì •ìƒì´ë©´ ë™ê¸°í™”ë„ ê°€ëŠ¥í•œ ê²ƒìœ¼ë¡œ íŒë‹¨
                const backendOk = statusEl.children[0] && statusEl.children[0].textContent.includes('ì •ìƒ');
                const frontendOk = statusEl.children[1] && statusEl.children[1].textContent.includes('ì •ìƒ');
                
                if (backendOk && frontendOk) {
                    statusEl.children[2].innerHTML = `<span class="sync-indicator sync-ok"></span>ë™ê¸°í™”: API ê¸°ë°˜ ë™ê¸°í™” ê°€ëŠ¥`;
                } else if (backendOk) {
                    statusEl.children[2].innerHTML = `<span class="sync-indicator sync-warning"></span>ë™ê¸°í™”: ë°±ì—”ë“œë§Œ ê°€ëŠ¥`;
                } else {
                    statusEl.children[2].innerHTML = `<span class="sync-indicator sync-error"></span>ë™ê¸°í™”: ë™ê¸°í™” ë¶ˆê°€`;
                }
            }
        }

        // WebSocket ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testWebSocketConnection() {
            try {
                const ws = new WebSocket('ws://localhost:8000/ws');
                let connected = false;
                
                return new Promise((resolve) => {
                    ws.onopen = function() {
                        connected = true;
                        showResult('websocket', true, { message: 'WebSocket ì—°ê²° ì„±ê³µ' });
                        ws.send('test sync message');
                    };
                    
                    ws.onmessage = function(event) {
                        showResult('websocket', true, { message: `WebSocket ì‘ë‹µ: ${event.data}` });
                        ws.close();
                        resolve(true);
                    };
                    
                    ws.onerror = function(error) {
                        showResult('websocket', false, { message: 'WebSocket ì—°ê²° ì‹¤íŒ¨ - HTTP í´ë§ìœ¼ë¡œ ëŒ€ì²´' });
                        resolve(false);
                    };
                    
                    ws.onclose = function() {
                        if (connected) {
                            showResult('websocket', true, { message: 'WebSocket ì—°ê²° ì •ìƒ ì¢…ë£Œ' });
                        }
                    };
                    
                    // 3ì´ˆ íƒ€ì„ì•„ì›ƒ
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING) {
                            ws.close();
                            showResult('websocket', false, { message: 'WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ' });
                            resolve(false);
                        }
                    }, 3000);
                });
            } catch (error) {
                showResult('websocket', false, { message: `WebSocket ì˜¤ë¥˜: ${error.message}` });
                return false;
            }
        }

        // ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
        function startRealTimeMonitoring() {
            if (monitoringInterval) clearInterval(monitoringInterval);
            monitoringInterval = setInterval(refreshSystemStatus, 5000);
            showResult('system', true, { message: 'ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘ë¨ (5ì´ˆ ê°„ê²©)' });
        }

        function stopRealTimeMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                showResult('system', true, { message: 'ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨' });
            }
        }

        // ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
        async function testBackendLogin() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        site_id: 'testuser20250926012525',
                        password: '1234'
                    })
                });
                const data = await response.json();
                if (data.access_token) {
                    authToken = data.access_token;
                    data._token_stored = true;
                }
                document.getElementById('backend-result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('backend-result').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        async function testBackendShop() {
            try {
                const response = await fetch(`${API_BASE}/api/shop/catalog`);
                const data = await response.json();
                document.getElementById('backend-result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('backend-result').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        async function testBackendEvents() {
            if (!authToken) {
                document.getElementById('backend-result').textContent = 'ë¨¼ì € ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”';
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/events/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                document.getElementById('backend-result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('backend-result').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
        async function testFrontendLogin() {
            try {
                const response = await fetch(`${FRONTEND_BASE}/login`, { method: 'HEAD' });
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    success: response.ok,
                    url: `${FRONTEND_BASE}/login`
                };
                document.getElementById('frontend-result').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('frontend-result').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        async function testFrontendShop() {
            try {
                const response = await fetch(`${FRONTEND_BASE}/shop`, { method: 'HEAD' });
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    success: response.ok,
                    url: `${FRONTEND_BASE}/shop`
                };
                document.getElementById('frontend-result').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('frontend-result').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        async function testFrontendAdmin() {
            try {
                const response = await fetch(`${FRONTEND_BASE}/admin`, { method: 'HEAD' });
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    success: response.ok,
                    url: `${FRONTEND_BASE}/admin`
                };
                document.getElementById('frontend-result').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                document.getElementById('frontend-result').textContent = `ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // ë™ê¸°í™” í…ŒìŠ¤íŠ¸
        async function runPurchaseSync() {
            showResult('sync', true, { message: 'êµ¬ë§¤ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...' });
            
            const results = [];
            
            // 1. ë°±ì—”ë“œì—ì„œ ì”ì•¡ í™•ì¸
            if (!authToken) await testBackendLogin();
            
            try {
                const beforeBalance = await fetch(`${API_BASE}/api/users/balance`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const beforeData = await beforeBalance.json();
                results.push({ step: 'êµ¬ë§¤_ì „_ì”ì•¡', backend: beforeData });
                
                // 2. êµ¬ë§¤ ì‹¤í–‰ (ì˜¬ë°”ë¥¸ ìŠ¤í‚¤ë§ˆ ì‚¬ìš©)
                const purchase = await fetch(`${API_BASE}/api/shop/buy`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}` 
                    },
                    body: JSON.stringify({
                        user_id: 23,  // JWTì—ì„œ ì¶”ì¶œëœ user_id ì‚¬ìš©
                        product_id: 1001,  // ê³¨ë“œ ìƒí’ˆ ID
                        quantity: 1
                    })
                });
                const purchaseData = await purchase.json();
                results.push({ step: 'êµ¬ë§¤_ì‹¤í–‰', backend: purchaseData });
                
                // 3. ì ì‹œ ëŒ€ê¸° í›„ ì”ì•¡ ì¬í™•ì¸
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const afterBalance = await fetch(`${API_BASE}/api/users/balance`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const afterData = await afterBalance.json();
                results.push({ step: 'êµ¬ë§¤_í›„_ì”ì•¡', backend: afterData });
                
                // 4. í”„ë¡ íŠ¸ì—”ë“œì—ì„œë„ í™•ì¸ (iframe ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ìƒíƒœ í™•ì¸)
                refreshPreview('shop-preview', `${FRONTEND_BASE}/shop`);
                results.push({ step: 'í”„ë¡ íŠ¸ì—”ë“œ_ìƒˆë¡œê³ ì¹¨', message: 'ìƒì  í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ë¨' });
                
                showResult('sync', true, { purchase_sync_results: results });
                
            } catch (error) {
                showResult('sync', false, { error: error.message, results });
            }
        }

        async function runEventSync() {
            showResult('sync', true, { message: 'ì´ë²¤íŠ¸ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...' });
            
            const results = [];
            
            if (!authToken) await testBackendLogin();
            
            try {
                // 1. ì´ë²¤íŠ¸ ëª©ë¡ ì¡°íšŒ
                const events = await fetch(`${API_BASE}/api/events/`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const eventsData = await events.json();
                results.push({ step: 'ì´ë²¤íŠ¸_ëª©ë¡', backend: eventsData });
                
                if (eventsData.length > 0) {
                    const eventId = eventsData[0].id;
                    
                    // 2. ì´ë²¤íŠ¸ ì°¸ì—¬
                    const join = await fetch(`${API_BASE}/api/events/join`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}` 
                        },
                        body: JSON.stringify({ event_id: eventId })
                    });
                    const joinData = await join.json();
                    results.push({ step: 'ì´ë²¤íŠ¸_ì°¸ì—¬', backend: joinData });
                    
                    // 3. í”„ë¡ íŠ¸ì—”ë“œ ì´ë²¤íŠ¸ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                    refreshPreview('main-preview', `${FRONTEND_BASE}/events`);
                    results.push({ step: 'í”„ë¡ íŠ¸ì—”ë“œ_ìƒˆë¡œê³ ì¹¨', message: 'ì´ë²¤íŠ¸ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ë¨' });
                }
                
                showResult('sync', true, { event_sync_results: results });
                
            } catch (error) {
                showResult('sync', false, { error: error.message, results });
            }
        }

        async function runAdminSync() {
            showResult('sync', true, { message: 'ì–´ë“œë¯¼ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹œì‘...' });
            
            const results = [];
            
            try {
                // 1. ì–´ë“œë¯¼ ë¡œê·¸ì¸
                const adminLogin = await fetch(`${API_BASE}/api/auth/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        site_id: 'admin',
                        password: 'admin123'
                    })
                });
                const adminData = await adminLogin.json();
                if (adminData.access_token) {
                    adminToken = adminData.access_token;
                }
                results.push({ step: 'ì–´ë“œë¯¼_ë¡œê·¸ì¸', backend: adminData });
                
                // 2. ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
                const users = await fetch(`${API_BASE}/api/admin/users?limit=5`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const usersData = await users.json();
                results.push({ step: 'ì‚¬ìš©ì_ëª©ë¡', backend: usersData });
                
                // 3. ì–´ë“œë¯¼ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                refreshPreview('admin-preview', `${FRONTEND_BASE}/admin`);
                results.push({ step: 'ì–´ë“œë¯¼_í˜ì´ì§€_ìƒˆë¡œê³ ì¹¨', message: 'ì–´ë“œë¯¼ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ë¨' });
                
                showResult('sync', true, { admin_sync_results: results });
                
            } catch (error) {
                showResult('sync', false, { error: error.message, results });
            }
        }

        // ì „ì²´ í’€ìŠ¤íƒ í…ŒìŠ¤íŠ¸
        async function runFullStackTest() {
            const btn = document.getElementById('full-test-btn');
            const progress = document.getElementById('full-test-progress');
            const progressDetails = document.getElementById('progress-details');
            
            btn.disabled = true;
            progress.style.display = 'block';
            
            const allResults = [];
            
            const tests = [
                { name: 'ì‹œìŠ¤í…œ_ìƒíƒœ_í™•ì¸', fn: refreshSystemStatus },
                { name: 'ë°±ì—”ë“œ_ë¡œê·¸ì¸', fn: testBackendLogin },
                { name: 'ë°±ì—”ë“œ_ìƒì ', fn: testBackendShop },
                { name: 'ë°±ì—”ë“œ_ì´ë²¤íŠ¸', fn: testBackendEvents },
                { name: 'í”„ë¡ íŠ¸ì—”ë“œ_ë¡œê·¸ì¸_í˜ì´ì§€', fn: testFrontendLogin },
                { name: 'í”„ë¡ íŠ¸ì—”ë“œ_ìƒì _í˜ì´ì§€', fn: testFrontendShop },
                { name: 'í”„ë¡ íŠ¸ì—”ë“œ_ì–´ë“œë¯¼_í˜ì´ì§€', fn: testFrontendAdmin },
                { name: 'êµ¬ë§¤_ë™ê¸°í™”', fn: runPurchaseSync },
                { name: 'ì´ë²¤íŠ¸_ë™ê¸°í™”', fn: runEventSync },
                { name: 'ì–´ë“œë¯¼_ë™ê¸°í™”', fn: runAdminSync }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                progressDetails.innerHTML = `ğŸ”„ ì§„í–‰ ì¤‘: ${test.name} (${i + 1}/${tests.length})`;
                
                try {
                    await test.fn();
                    allResults.push({ test: test.name, success: true, timestamp: new Date().toISOString() });
                } catch (error) {
                    allResults.push({ test: test.name, success: false, error: error.message, timestamp: new Date().toISOString() });
                }
                
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            // ê²°ê³¼ ì •ë¦¬
            const summary = {
                total: allResults.length,
                passed: allResults.filter(r => r.success).length,
                failed: allResults.filter(r => !r.success).length,
                completion_time: new Date().toISOString()
            };
            
            showResult('full-test', true, { 
                message: 'ì „ì²´ í’€ìŠ¤íƒ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!',
                summary: summary,
                detailed_results: allResults
            });
            
            btn.disabled = false;
            progress.style.display = 'none';
        }

        // ë™ê¸°í™” ë¬¸ì œ ì§„ë‹¨
        async function runSyncDiagnosis() {
            showResult('full-test', true, { message: 'ë™ê¸°í™” ë¬¸ì œ ì§„ë‹¨ ì‹œì‘...' });
            
            const diagnosis = {
                backend_apis: [],
                frontend_pages: [],
                sync_points: [],
                recommendations: []
            };
            
            // ë°±ì—”ë“œ API ìƒíƒœ ì²´í¬
            const backendEndpoints = [
                '/health',
                '/api/auth/login',
                '/api/shop/catalog',
                '/api/events/',
                '/api/admin/users'
            ];
            
            for (const endpoint of backendEndpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, { method: 'HEAD' });
                    diagnosis.backend_apis.push({
                        endpoint: endpoint,
                        status: response.status,
                        working: response.ok
                    });
                } catch (error) {
                    diagnosis.backend_apis.push({
                        endpoint: endpoint,
                        status: 0,
                        working: false,
                        error: error.message
                    });
                }
            }
            
            // í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€ ìƒíƒœ ì²´í¬
            const frontendPages = [
                '/',
                '/login',
                '/shop',
                '/events',
                '/admin'
            ];
            
            for (const page of frontendPages) {
                try {
                    const response = await fetch(`${FRONTEND_BASE}${page}`, { method: 'HEAD' });
                    diagnosis.frontend_pages.push({
                        page: page,
                        status: response.status,
                        working: response.ok
                    });
                } catch (error) {
                    diagnosis.frontend_pages.push({
                        page: page,
                        status: 0,
                        working: false,
                        error: error.message
                    });
                }
            }
            
            // ë™ê¸°í™” í¬ì¸íŠ¸ ì²´í¬
            diagnosis.sync_points.push({
                type: 'WebSocket',
                description: 'WebSocket ì‹¤ì‹œê°„ í†µì‹  í™•ì¸ í•„ìš”',
                status: 'manual_check_required'
            });
            
            diagnosis.sync_points.push({
                type: 'Token_Persistence',
                description: 'ë¡œê·¸ì¸ í† í° localStorage ì €ì¥ í™•ì¸ í•„ìš”',
                status: 'manual_check_required'
            });
            
            diagnosis.sync_points.push({
                type: 'State_Management',
                description: 'í”„ë¡ íŠ¸ì—”ë“œ ì „ì—­ ìƒíƒœ ê´€ë¦¬ í™•ì¸ í•„ìš”',
                status: 'manual_check_required'
            });
            
            // ê¶Œì¥ì‚¬í•­ ìƒì„±
            const failedBackend = diagnosis.backend_apis.filter(api => !api.working);
            const failedFrontend = diagnosis.frontend_pages.filter(page => !page.working);
            
            if (failedBackend.length > 0) {
                diagnosis.recommendations.push(`ë°±ì—”ë“œ API ë¬¸ì œ: ${failedBackend.map(api => api.endpoint).join(', ')} í™•ì¸ í•„ìš”`);
            }
            
            if (failedFrontend.length > 0) {
                diagnosis.recommendations.push(`í”„ë¡ íŠ¸ì—”ë“œ í˜ì´ì§€ ë¬¸ì œ: ${failedFrontend.map(page => page.page).join(', ')} í™•ì¸ í•„ìš”`);
            }
            
            if (failedBackend.length === 0 && failedFrontend.length === 0) {
                diagnosis.recommendations.push('APIì™€ í˜ì´ì§€ëŠ” ì •ìƒ, ì‹¤ì‹œê°„ ë™ê¸°í™” ë¡œì§ í™•ì¸ í•„ìš”');
                diagnosis.recommendations.push('ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ì—ì„œ WebSocket ì—°ê²° ìƒíƒœ í™•ì¸');
                diagnosis.recommendations.push('localStorageì˜ auth_token ë° ì „ì—­ ìƒíƒœ í™•ì¸');
            }
            
            showResult('full-test', true, { 
                message: 'ë™ê¸°í™” ë¬¸ì œ ì§„ë‹¨ ì™„ë£Œ',
                diagnosis: diagnosis
            });
        }

        // í”„ë¦¬ë·° ê´€ë ¨ í•¨ìˆ˜
        function refreshPreview(iframeId, url) {
            const iframe = document.getElementById(iframeId);
            iframe.src = url + '?t=' + Date.now(); // ìºì‹œ ë°©ì§€
        }

        function openInNewTab(url) {
            window.open(url, '_blank');
        }

        // ê²°ê³¼ í‘œì‹œ í—¬í¼
        function showResult(sectionId, success, data) {
            const statusEl = document.getElementById(`${sectionId}-status`);
            const resultEl = document.getElementById(`${sectionId}-result`);
            
            if (statusEl) {
                statusEl.className = `status ${success ? 'success' : 'error'}`;
                statusEl.textContent = success ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
            }
            
            if (resultEl) {
                resultEl.textContent = JSON.stringify(data, null, 2);
            }
        }

        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°
        function exportTestResults() {
            const results = {
                timestamp: new Date().toISOString(),
                backend_result: document.getElementById('backend-result')?.textContent || '',
                frontend_result: document.getElementById('frontend-result')?.textContent || '',
                sync_result: document.getElementById('sync-result')?.textContent || '',
                full_test_result: document.getElementById('full-test-result')?.textContent || ''
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fullstack_test_results_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í™•ì¸
        window.addEventListener('load', () => {
            refreshSystemStatus();
            
            // iframe ë¡œë“œ ì—ëŸ¬ ì²˜ë¦¬
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                iframe.addEventListener('error', () => {
                    console.warn(`iframe ë¡œë“œ ì‹¤íŒ¨: ${iframe.src}`);
                });
            });
        });
    </script>
</body>
</html>