<!DOCTYPE html>
<html>
<head>
    <title>Admin Login Debug</title>
</head>
<body>
    <h1>관리자 로그인 디버깅</h1>
    
    <div>
        <h3>1. 현재 토큰 상태</h3>
        <button onclick="checkTokens()">토큰 확인</button>
        <button onclick="clearAllTokens()">모든 토큰 삭제</button>
        <div id="tokenStatus"></div>
    </div>
    
    <div>
        <h3>2. 관리자 로그인 테스트</h3>
        <button onclick="testAdminLogin()">관리자 로그인 (admin/123456)</button>
        <div id="loginResult"></div>
    </div>
    
    <div>
        <h3>3. API 호출 테스트</h3>
        <button onclick="testAdminAPI()">사용자 목록 API 호출</button>
        <div id="apiResult"></div>
    </div>

    <script>
        function checkTokens() {
            const unified = localStorage.getItem('cc_auth_tokens');
            const legacy = localStorage.getItem('cc_access_token');
            const adminToken = localStorage.getItem('admin_token');
            const adminRefresh = localStorage.getItem('admin_refresh_token');
            
            document.getElementById('tokenStatus').innerHTML = `
                <p><strong>통합 토큰 (cc_auth_tokens):</strong> ${unified ? '존재' : '없음'}</p>
                <p><strong>레거시 토큰 (cc_access_token):</strong> ${legacy ? '존재' : '없음'}</p>
                <p><strong>관리자 토큰 (admin_token):</strong> ${adminToken ? '존재' : '없음'}</p>
                <p><strong>관리자 리프레시 (admin_refresh_token):</strong> ${adminRefresh ? '존재' : '없음'}</p>
                <p><strong>쿠키:</strong> ${document.cookie || '없음'}</p>
            `;
        }
        
        function clearAllTokens() {
            localStorage.removeItem('cc_auth_tokens');
            localStorage.removeItem('cc_access_token');
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_refresh_token');
            
            // 쿠키도 삭제
            document.cookie = 'auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            
            alert('모든 토큰이 삭제되었습니다.');
            checkTokens();
        }
        
        async function testAdminLogin() {
            try {
                console.log('[DEBUG] 관리자 로그인 API 호출 시작...');
                
                const response = await fetch('/api/auth/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        site_id: 'admin',
                        password: '123456'
                    })
                });
                
                console.log('[DEBUG] Response status:', response.status);
                console.log('[DEBUG] Response headers:', response.headers);
                
                const data = await response.json();
                console.log('[DEBUG] Response data:', data);
                
                if (response.ok && data.access_token) {
                    console.log('[DEBUG] 토큰 저장 중...');
                    // 통합 토큰 저장소 사용
                    const tokenData = {
                        access_token: data.access_token,
                        refresh_token: data.refresh_token || data.access_token
                    };
                    
                    localStorage.setItem('cc_auth_tokens', JSON.stringify(tokenData));
                    
                    // 쿠키도 수동으로 설정
                    document.cookie = `auth_token=${data.access_token}; path=/; max-age=86400; SameSite=Lax`;
                    
                    console.log('[DEBUG] 토큰 저장 완료');
                    
                    document.getElementById('loginResult').innerHTML = `
                        <p style="color: green;"><strong>로그인 성공!</strong></p>
                        <p>액세스 토큰: ${data.access_token.substring(0, 50)}...</p>
                        <p>리프레시 토큰: ${data.refresh_token || '없음'}</p>
                        <p>사용자: ${JSON.stringify(data.user, null, 2)}</p>
                    `;
                    checkTokens();
                } else {
                    document.getElementById('loginResult').innerHTML = `
                        <p style="color: red;"><strong>로그인 실패!</strong></p>
                        <p>상태: ${response.status}</p>
                        <p>응답: ${JSON.stringify(data, null, 2)}</p>
                    `;
                }
            } catch (error) {
                console.error('[DEBUG] 로그인 오류:', error);
                document.getElementById('loginResult').innerHTML = `
                    <p style="color: red;"><strong>로그인 오류!</strong></p>
                    <p>${error.message}</p>
                    <p>Stack: ${error.stack}</p>
                `;
            }
        }
        
        async function testAdminAPI() {
            try {
                const tokens = JSON.parse(localStorage.getItem('cc_auth_tokens') || '{}');
                
                if (!tokens.access_token) {
                    document.getElementById('apiResult').innerHTML = `
                        <p style="color: orange;">토큰이 없습니다. 먼저 로그인하세요.</p>
                    `;
                    return;
                }
                
                const response = await fetch('/api/admin/users?limit=5', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${tokens.access_token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiResult').innerHTML = `
                        <p style="color: green;"><strong>API 호출 성공!</strong></p>
                        <p>상태: ${response.status}</p>
                        <p>사용자 수: ${Array.isArray(data) ? data.length : '불명'}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    document.getElementById('apiResult').innerHTML = `
                        <p style="color: red;"><strong>API 호출 실패!</strong></p>
                        <p>상태: ${response.status}</p>
                        <p>응답: ${JSON.stringify(data, null, 2)}</p>
                    `;
                }
            } catch (error) {
                document.getElementById('apiResult').innerHTML = `
                    <p style="color: red;"><strong>API 호출 오류!</strong></p>
                    <p>${error.message}</p>
                `;
            }
        }
        
        // 페이지 로드 시 토큰 상태 확인
        window.onload = checkTokens;
    </script>
</body>
</html>
