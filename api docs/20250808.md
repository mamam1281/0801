## 2025-09-08 – ShopScreen 리팩터링: 폴백 정규화 · oneTime/bonusGold UI · 상태 머신 도입

### 변경 요약
- 내부 중복 상수 `SHOP_ITEMS` 제거하고 `utils/shop.ts`의 `FALLBACK_SHOP_ITEMS` + `normalizeCatalog` 사용으로 단일 소스화 및 정규화 계층 도입 (서버 카탈로그/API 항목 → 통합 `NormalizedShopItem` 형태).
- 구매 UI 개선: oneTime 아이템 1회 구매 후 버튼 비활성(로컬 Set 관리), bonusGold 배지(+XG) 및 실수령 골드(기본 value+bonusGold) 표시, 할인/한정/1회/보너스 배지 병렬 지원.
- 로딩/오류/빈 상태 분기: skeleton(8개 카드) · 오류(fallback 안내) · 빈 카탈로그 처리, 폴백 사용 시에도 정규화 경로 동일하게 적용.
- 가격 계산/실수령 로직 중복 제거: `calcFinalPrice`, `calcEffectiveGold` 활용, 할인 경계값(0~95%) 클램프.
- oneTime 구매 직후 로컬 비활성 처리 + balance 재동기화(`syncBalance`) 순서 확정, 추후 서버 권위(oneTime 구매 이력) 동기화 확장 여지 남김.

### 검증
- 에디터 기준 타입 오류 없음(`NormalizedShopItem` 경로 및 import 정상). 기존 컴포넌트 외 영향 없음.
- 정규화 입력: (1) `shop/catalog` (2) `shop/items` (3) 둘 다 실패 → 빈 raw → FALLBACK 경로; 세 경로 모두 `normalizeCatalog` 통해 동일 스키마 확보.
- 위험/잔존 리스크: oneTime 구매 이력 현재 세션 로컬 한정(새로고침/로그인 재개 시 서버 측 재구매 방지 로직 필요), 서버 카탈로그 필드 누락 시 기본값 적용(추후 필수 필드 스키마 검증 필요), build/test 미실행 상태(컨테이너 필요).

### 다음 단계
1) 단위 테스트 작성: `calcFinalPrice`, `calcEffectiveGold`, `normalizeCatalog`, `isOneTimePurchased` (경계: discount 음수/95% 초과, bonusGold=0/undefined, 중복 ID).
2) oneTime 서버 권위 동기화(프로필/인벤토리 or 구매 히스토리 기반) 후 로컬 Set 초기화 로직 추가.
3) 카탈로그 API 실패 사유 surfaced(HTTP code/메시지) → 현재 단순 fallback 메시지 개선 및 OpenAPI 스키마 확정 시 재수출.

---
## 2025-09-07 – TypeScript 컴파일 오류 해결 및 프론트엔드 개발환경 안정화

### 변경 요약
- TypeScript 컴파일 오류 3건 체계적 해결: levelUtils.ts 모듈 생성, Login 페이지 prop 타입 수정, HomeDashboard import 오류 해결
- 프론트엔드 개발환경 완전 안정화: 모든 컴파일 오류 해결로 healthy 상태 유지, 레벨 시스템 유틸리티 함수 표준화 완료

### 검증
- 모든 TypeScript 컴파일 오류 해결 완료 (levelUtils.ts, login/page.tsx, App.tsx)
- 프론트엔드 컨테이너 healthy 상태로 재시작 완료 (0.9초)
- 레벨 계산 시스템 안정화: calculateLevelProgress 함수 정상 구현

### 다음 단계
- 브라우저 테스트: http://localhost:3000/login 접속하여 로그인 페이지 정상 표시 확인
- 레벨 시스템 테스트: HomeDashboard에서 새로 생성된 함수 정상 동작 확인
- 전체 네비게이션 플로우: 로그인→메인→게임 페이지 이동 시 오류 없음 확인

### 기술적 개선사항
```typescript
// levelUtils.ts: 완전 새로 구현된 레벨 시스템 유틸리티
export function calculateLevelProgress(experiencePoints: number): LevelProgress {
  const XP_PER_LEVEL = 500;
  const currentLevel = Math.floor(experiencePoints / XP_PER_LEVEL) + 1;
  const currentXP = experiencePoints % XP_PER_LEVEL;
  const progressPercentage = (currentXP / XP_PER_LEVEL) * 100;
  
  return { currentLevel, currentXP, xpForNextLevel: XP_PER_LEVEL, progressPercentage };
}
```

## 2025-09-02 – 전역 동기화 정리 및 Parity 게이트 절차 명시

### 변경 요약
- FE 전역 동기화 마이그레이션 마무리: useGlobalSync 고정, useDashboard/useBalanceSync 소스 삭제 및 클린 빌드로 산출물(.next) 참조 제거 완료.
- /api/games/stats/me 응답 포맷 단일화 방향 확정: `{ success: true, stats: {...} }` 기준으로 FE unwrap 하위호환 유지(다음 릴리스에서 루트 본문 fallback 제거 예고).

### 검증
- Playwright(무 parity) 컨테이너 3회 연속 그린 확인.
- 백엔드 GameStats 관련 pytest 그린 유지, Alembic heads 단일 유지.
- /docs 정상 노출.

### 다음 단계
- E2E_REQUIRE_STATS_PARITY=1 게이트 검증: /api/games/stats/me 200 x2 + UI=API 3회 PASS.
- 게이트 통과 후 E2E_REQUIRE_STATS_PARITY=1에서 1회 그린 + deep 1회(선택) → STRICT_STATS_PARITY=1 검토.
- 필요 시 OpenAPI 재수출 및 current_openapi.json 업데이트.

### OpenAPI 재수출 절차(컨테이너 내부)
```powershell
# 백엔드 컨테이너 셸 진입 후 실행 예시
python -m app.export_openapi
# 산출물 위치 확인 및 current_openapi.json 동기화
```

### 2025-09-01 – FE 전역 동기화 일원화(파일 삭제): useBalanceSync/useDashboard 제거 + 3연속 그린

- 변경 요약: 레거시 훅 파일 `frontend/hooks/useBalanceSync.ts`, `frontend/hooks/useDashboard.ts`를 소스에서 삭제. 호출처는 모두 `useGlobalSync`/셀렉터 조합으로 대체 완료. 불필요한 중복 훅 제거로 유지보수성 향상, 권위 동기화 단일화.
- 검증 결과: 컨테이너형 Playwright 3회 연속 그린(각 37 passed / 12 skipped / 0 failed) 유지. 백엔드 스키마/알렘빅/오픈API 변경 없음. .next 빌드 산출물은 클린 빌드 시 자동 정리 예정.
- 다음 단계: (1) 클린 빌드 후 산출물 내 레거시 참조 제거 확인 (2) `E2E_REQUIRE_STATS_PARITY=1` 승격 및 모니터링 (3) STRICT_STATS_PARITY 전환 전 2~3회 추가 그린 확보.

### 2025-09-01 – FE 전역 동기화 일원화: useBalanceSync 호출처 전환 및 E2E 그린 + useDashboard 제거(소스)

- 변경 요약: 레거시 훅 `useBalanceSync` 의존을 제거하고 `useGlobalSync`로 잔액 동기화를 일원화. 변경 파일: `frontend/components/ShopScreen.tsx`(구매 후 reconcileBalance→syncBalance), `frontend/components/games/NeonSlotGame.tsx`(useBalanceSync import/사용 제거), `frontend/components/games/GachaSystem.tsx`(fallback reconcileBalance→syncBalance). 전역 체크리스트(`전역동기화_솔루션.md`) 업데이트.
- 검증 결과: 컨테이너형 Playwright 49 tests → 37 passed / 12 skipped / 0 failed, exit code 0. gacha/통화 정합 스펙 PASS, GOLD 일관성/액션 페이지네이션/접근성·SEO 유지. 백엔드 스키마/알렘빅/오픈API 변경 없음.
- 다음 단계: (1) 연속 3회 Playwright 그린 확보 후 `E2E_REQUIRE_STATS_PARITY=1` 승격 검토(현재 1/3) (2) 레거시 훅 파일 제거 PR 병합 및 .next 클린 빌드 (3) 문서 동기화(전역동기화_솔루션.md/개선안2.md).

### 2025-09-01 – Playwright 전체 스위트 그린(컨테이너) · PR #5 기준

- 변경 요약: PR #5 머지 기준(main@0945e67)에서 컨테이너형 Playwright 49 tests 실행 → 37 passed / 12 skipped / 0 failed. a11y(/, /login, /shop), SEO, action_history_pagination(ts/js), admin_points_ui, admin_shop_refetch, unifiedApi 재시도 스펙 PASS. Realtime(deep)/shop inventory/stats parity 등 가드된 스펙은 스킵됨.
- 검증 결과: 러너 종료 코드 0. 백엔드 /health 200, /docs 정상 노출, Alembic heads 단일 유지(c6a1b5e2e2b1). ws_profile_update_smoke 경고 로그 1회 있었으나 PASS.
- 다음 단계: (1) /api/games/stats/me 200 지속 모니터링 후 E2E_REQUIRE_STATS_PARITY=1 승격 검토 (2) 필요 시 OpenAPI 재수출 및 drift guard 재검증 (3) 릴리즈 노트/문서에 결과 반영 유지.

### 2025-09-01 – /api/games/stats/me 안정화 및 E2E 파리티 승격(로컬 deep)

- 변경 요약: `app/routers/games.py`에서 `/stats/me` 라우트를 `/stats/{user_id}`보다 위로 이동해 경로 충돌(422 int_parsing: 'me')을 해소. `/api/games/stats/me` 200 OK 확인 후 `docker-compose.playwright.deep.yml`에 `E2E_REQUIRE_STATS_PARITY=1`를 활성화(로컬 deep 프로파일 한정).
- 검증 결과: 신규 회원 가입→토큰 발급 후 `/api/games/stats/me` 200 및 JSON 스키마 수신 확인. `pytest -q app/tests/test_smoke_health.py` 2 passed. compose 오버레이 병합 검증 통과(`docker compose ... config`).
- 다음 단계: (1) 2회 이상 빌드 라운드에서 `/api/games/stats/me` 200 지속 모니터링 (2) GitHub Actions에서 `vars.E2E_REQUIRE_STATS_PARITY` 승격 고려 (3) FE E2E(stats_ui_parity.spec) 엄격 모드에서 3회 연속 PASS 달성 시 CI 기본값 상향.

### 2025-09-01 – FE 동기화 훅 보강 및 분산 훅 스윕 계획 기록

- 변경 요약: `useGlobalSync.syncGameStats`가 `/api/games/stats/me`의 래핑/루트/배열/객체형 응답을 모두 정규화하여 `SET_GAME_STATS`로 반영하도록 보강. 전역 문서 상단에 진행 체크리스트 및 분산 훅 스윕/제거 체크리스트 추가.
- 검증 결과: 타입 오류 없음. 기존 E2E 스모크(`games_stats_api_smoke.spec`) 조건 하에서 동작 동일. 로그인 전 403 소음 미발생 유지.
- 다음 단계: (1) 백엔드 포맷 단일화 여부 확정 시 FE 셀렉터 키 목록 재확인 (2) `useBalanceSync` 등 제거 대상의 호출처 대체 후 삭제 PR 진행 (3) 2회 빌드에서 `/api/games/stats/me` 200 연속 확인되면 `E2E_REQUIRE_STATS_PARITY=1` 승격 준비.

### 2025-09-01 – OpenAPI 재수출 및 드리프트 가드 통과

- 변경 요약: 컨테이너 내부에서 `python -m app.export_openapi` 실행으로 스키마 재수출. canonical(`/app/current_openapi.json`)과 앱 로컬(`/app/app/current_openapi.json`) 모두 생성/갱신, 스냅샷 파일 기록.
- 검증 결과: `pytest -q app/tests/test_openapi_diff_ci.py` 2 passed, 드리프트 없음. 기능 스키마 변경 없음으로 FE 타입 재생성 불필요.
- 다음 단계: 이후 엔드포인트/스키마 변경 시 동일 루틴 재수행 및 본 문서 상단에 차이 요약 추가.

### 2025-09-01 – Alembic 가드 적용 및 DB 부트스트랩 복구

- 변경 요약
	- `9dbe94486d67_safe_align_models_non_destructive_2025_.py` 내 `user_rewards` 관련 변경을 테이블 존재 가드로 보호하여 UndefinedTable 오류를 차단(존재 시에만 alter/index 수행).
	- 컨테이너 내부에서 `alembic upgrade head` 실행하여 초기 스키마(users 등) 부트스트랩 완료. 최종 head 단일 유지(현재 head=c6a1b5e2e2b1).
	- 백엔드 재시작 후 스키마 드리프트 가드 통과, 앱 정상 기동.

- 검증 결과
	- `docker compose restart backend` 후 로그: “✅ Backend startup complete”, `/health 200`, `/docs 200`, `/openapi.json 200` 확인.
	- Alembic: `heads -v` 단일 head, `current -v` 최신 리비전 도달. `alembic upgrade head` 실행 로그에서 초기 리비전→head까지 순차 적용 확인.
	- OpenAPI: 런타임 스키마 정상 노출, `app/current_openapi.json` 존재. 필요시 재수출 수행 예정.

- 다음 단계
	1) 컨테이너 내부 `pytest -q app/tests --maxfail=1`로 스모크 재검증 및 실패 항목 트리아지.
	2) `python -m app.export_openapi` 재수출 및 drift 여부 확인(필요 시 본 문서 상단에 차이 요약 추가).
	3) `개선안.md`에 트러블슈팅 타임라인과 명령, 로그 요약 기록(완료) – 재발 방지 체크리스트 유지.

## 변경 요약: 시드 데이터 정리 정책 전환 (2025-08-31)

- 가짜/목 시드 데이터 생성 금지. 실제 계정 활동만 반영하도록 전략 전환
- 스크립트 정비:
	- `cc-webapp/backend/clean_seed_only.py`: 주요 테이블(game_sessions, user_actions, shop_transactions 등)에서 시드계정 이외 데이터 삭제 + 시드계정 기본 상태 리셋
	- `cc-webapp/backend/seed_realistic_data.py`: 가짜 생성 로직 제거, 정리/리셋/현황 출력 전용으로 단순화
- 이벤트/미션/가챠 연계 테이블(event_participations, user_missions, gacha_log)도 존재 시 정리 포함

### 2025-08-31 – 시드정리 FK 보완 및 인증 토큰 테이블 포함

- 변경 요약
	- `clean_seed_only.py`가 FK 안전 순서(자식→부모)로 테이블을 정리하고, 테이블별 개별 트랜잭션으로 실행하도록 개선.
	- 남아있던 FK 제약(`token_blacklist_blacklisted_by_fkey`) 해소를 위해 `token_blacklist`, `refresh_tokens` 등 인증/세션 관련 테이블을 정리 대상에 추가.

- 검증 결과
	- 컨테이너 실행 로그: token_blacklist 4건, refresh_tokens 28건 삭제 후 users 비시드 20개 삭제 성공. 시드계정 상태 초기화 완료.
	- /health 200, Alembic head 단일 유지(c6a1b5e2e2b1). pytest 부분 실행 시 auth 블랙리스트 테스트 1건 실패(원인: 로그아웃 후 토큰 차단 미적용) – 별도 트리아지 필요.

- 다음 단계
	1) auth 블랙리스트 경로 점검: 로그아웃 시 jti/유효 토큰을 DB/캐시에 블랙리스트하는지 확인, 미들웨어 검증 로직 활성화.
	2) 시드계정으로 로그인→간단 액션 수행 후 `/api/users/balance`, `/api/games/stats/me` 확인.
	3) 필요 시 OpenAPI 재수출 및 본 문서에 결과 추가.

## 검증

- 컨테이너 내부 실행: `docker compose exec backend python clean_seed_only.py`
- 결과: 시드계정(admin, user001~004)만 남기고 주요 테이블 정리, 초기 상태 리셋 로그 확인
- /health 200, /docs 노출 유지(백엔드 healthy 상태)

## 다음 단계

- 운영 전 점검: 실제 로그인으로 시드계정 활동 생성(게임 세션, 상점 구매 등) 확인
- 필요 시 보호 목록 확장(삭제 제외 테이블/칼럼 지정) 및 FK 제약 검토
- 문서/체크리스트에 시드 작업 루틴 추가(주기적 정리 여부 결정)

## 2025-08-31 – 백엔드 빠른 체크 스크립트 추가 및 pytest QUICK_SMOKE 경로

- 변경 요약
	- 컨테이너 내부에서 /health·/docs만 초간단 스모크하는 PowerShell 스크립트 추가: `scripts/backend-quick-check.ps1` (옵션: `-FastOnly`).
	- pytest 환경에 `QUICK_SMOKE=1` 경로를 사용해 DB/관리자 부트스트랩을 우회, 정지 이슈 없이 빠른 응답 검증.
	- Alembic는 운영 시간 외에만 정식 `upgrade head` 권장. 일상 점검은 `alembic heads -v` 단일 head 확인으로 대체.

- 검증 결과
	- 컨테이너 내부: `test_health_ok` PASS, `test_docs_available` PASS (경고만 출력, 기능 영향 없음).
	- `alembic heads -v` 단일 head 확인(c6a1b5e2e2b1). 기존 DB가 선행 생성된 환경에서 `upgrade head`는 DuplicateTable 가능 → 스킵.

- 다음 단계
	- DB 초기화/신규 환경에서만 `alembic upgrade head` 실행. 기존 환경은 `heads -v` 단일성 체크만 수행.
	- 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 후 드리프트 가드 재실행.

### 2025-08-29 – 서버배포·풀스택연동·전역동기화 종합 반영(첨부 기준)

	- `개선안.md`에 운영용 종합 실행 플랜 섹션(A~G: 성공기준/배포 절차/연동 규약/전역 동기화/페이지·어드민·게임 현황/프론트 헬스체크/운영 체크리스트) 추가.
	- 프론트 healthcheck 안정화 계획 수립: 경량 `GET /healthz` 도입 또는 `start_period` 60–90s 확대.
	- 현재 상태 기준: Playwright 컨테이너 27 passed / 3 skipped / 0 failed, 백엔드 `/health` 200, Alembic 단일 head 유지(레포 기준).
	- Admin Shop 엔드포인트 표준화: 프론트는 `/api/shop/admin/products` 네임스페이스만 사용. 백엔드의 레거시 `/api/admin/shop/items`는 deprecated 처리되며 다음 정책을 적용:
		- 목록/CRUD 계열: 307 Temporary Redirect → `/api/shop/admin/products*`로 자동 안내
		- 일부 보조 경로(예: 할인/랭크 변경): 410 Gone + JSON 가이드 메시지 반환
		- OpenAPI에서는 deprecated로 표기, 완전 제거 전까지 호환 기간 유지(추후 제거 일정 공지 예정)

	- `docker compose ps`: backend healthy, frontend는 dev 모드에서 `unhealthy` 플래그 가능 → 헬스체크 개선 필요.
	- OpenAPI: events 라우터 operation_id 중복 해소 반영 완료, drift guard 통과(최근 실행 기준).
	- 스키마/문서 싱크: `backend/current_openapi.json` 재수출 완료. `/api/admin/shop/items*` 경로는 deprecated로 노출되고 307/410 정책 설명이 문서에 반영됨.

	1) 프론트 healthcheck 안정화 적용 후 `docker compose ps`에서 healthy 확인.
	2) 컨테이너 내부 `python -m app.export_openapi` 재수출 → drift PASS → 필요 시 FE 타입 재생성.
	3) 컨테이너 Playwright 스위트 재실행(0 failed 유지) 후 본 문서에 결과 반영.

### 2025-08-31 – E2E 스모크 보강 및 가드 확장(게임 통계 API, Realtime 심화)

- 변경 요약
	- games_stats_api_smoke.spec.ts: `/api/games/stats/me` 스모크의 스킵 가드 확장(404/501/403/405/429 및 5xx 전체 + !ok) 및 조기 return 처리로 잔여 expect 미실행 보장.
	- Realtime 스펙 추가: `realtime_event_mapping.spec.ts`, `realtime_reconnect_throttle_dedupe.spec.ts` 추가(emit 라우터 필요 시 안전 스킵). 기존 `realtime_purchase_dedupe.spec.ts`와 조합하여 재연결·스로틀·중복 억제 케이스 스모크.
- 검증
	- 컨테이너 Playwright 전체: 41 total → 34 passed / 7 skipped / 0 failed.
	- games_stats_api_smoke는 대상 엔드포인트 비가용 환경에서 스킵 처리되어 전체 0 failed 유지.
	- ws_profile_update_smoke는 경고 로그만 출력 후 PASS(간접 정합성 확인).
- 다음 단계
	1) 백엔드 dev emit 라우터 활성화 시 E2E_REALTIME_DEEP=1로 심화 케이스 재검증.
	2) `/api/games/stats/me`가 200 안정화되면 UI 합계 일치 테스트로 확장.
	3) OpenAPI 재수출 후 타입 재생성 파이프라인과 결과 동기화.

### 2025-08-31 – 프로필 합계 셀렉터 추가 및 UI=API 파리티 스펙 도입(가드형)

- 변경 요약
	- `ProfileScreen`의 전체 요약 카드에 안정적인 테스트 셀렉터 추가: `data-testid="stats-total-games"`, `data-testid="stats-total-wins"`.
	- Playwright 스펙 `stats_ui_parity.spec.ts` 추가: `/api/games/stats/me` 응답이 200 OK일 때, UI의 합계 값과 API 값을 비교. 미가용/비정상 응답 시 안전 스킵.
- 검증
	- 로컬 에디터 기준 타입 오류 없음. 신규 스펙은 컨테이너 실행 시 엔드포인트 상태에 따라 자동 스킵/검증되도록 설계됨.
- 다음 단계
	1) 백엔드에서 `/api/games/stats/me` 200 안정화 모니터링 후 본 스펙이 활성 단언까지 도달하는지 확인(E2E_REQUIRE_STATS_PARITY=1로 강제 실패 전환 가능).
	2) 필요 시 합계 산출 키 매핑 확장(멀티 게임 스키마 반영). OpenAPI 재수출 후 타입 재생성 여부 점검.
	3) `signup_balance_smoke`와 함께 UI 정합 지표로 CI 리포트에 병기.

#### 스펙 활성화/엄격 모드 플래그
- Stats parity: E2E_DISABLE_STATS_PARITY=0, E2E_REQUIRE_STATS_PARITY=1 → 엔드포인트 비가용/스키마 불일치 시 fail
- Shop currency sync: E2E_SHOP_SYNC=1, E2E_REQUIRE_SHOP_SYNC=1 → 카탈로그/구매 경로 비가용 시 fail
- Realtime mapping: E2E_REALTIME_MAPPING=1, E2E_REQUIRE_REALTIME=1 → dev emit 미가용 시 fail
- Realtime dedupe: E2E_REALTIME_DEDUPE=1, E2E_REQUIRE_REALTIME=1

##### CI 주입 계획(요청 반영)
- `/api/games/stats/me` 200 안정화가 확인되는 배포부터 CI에서 `E2E_REQUIRE_STATS_PARITY=1`을 주입하여 UI=API 파리티를 필수 단언으로 승격합니다.
- 상점 경로/WS 토스트가 준비되면 `E2E_SHOP_SYNC=1`을 활성화하고, 이후 `E2E_REQUIRE_SHOP_SYNC=1`로 전환하여 미준비 환경에서 실패로 표준화합니다.
- dev emit 라우터 노출 시 `E2E_REALTIME_MAPPING=1` 활성(미가용 환경은 기존 스킵 유지). 안정화 이후 `E2E_REQUIRE_REALTIME=1`로 승격 가능합니다.

### 2025-08-31 – RPS 422 핫픽스 및 스모크 추가

- 변경 요약
	- 프론트 RockPaperScissorsGame의 요청 페이로드를 `{ hand }`에서 `{ choice, bet_amount }`로 수정하여 백엔드 `RPSPlayRequest` 스키마와 정합화했습니다.
	- Playwright에 `[Games] RPS smoke: server result & UI reflection` 스펙(`tests/e2e/rps_smoke.spec.ts`)을 추가했습니다.
- 검증
	- 컨테이너 Playwright 실행 결과: 43 total → 34 passed / 9 skipped / 0 failed. 기존 `rps_crash_balance_reconcile.spec` PASS 유지, 신규 `rps_smoke.spec`은 환경 조건 미충족 시 안전 스킵.
	- 백엔드 스키마/Alembic/OpenAPI 변경 사항 없음(프론트 요청 필드만 수정).
- 다음 단계
	1) `/api/games/stats/me` 200 안정화 시 “게임 4종 합계=API” 일치 스펙 활성화.
	2) RPS 응답 스키마가 확장될 경우 OpenAPI 재수출 및 타입 재생성 파이프라인 트리거.
	3) dev emit 기반 Realtime 심화(E2E_REALTIME_DEEP) 가용 시 RPS 포함 심화 시나리오 보강.

### 2025-08-29 – Admin Refetch Smoke, CI 코드 고정화, OpenAPI 재수출 계획, 잔여 어드민 최소 스코프

- 변경 요약
	- Playwright: `admin_shop_refetch_smoke.spec.ts` 추가. 업서트 직후 재조회로 카운트/필드 변경 즉시 반영 검증(삭제/복구 및 include_deleted 포함). elevate 실패 시 스킵 가드 유지.
	- CI 응답 코드 고정화(프로파일): 어드민 부정 케이스에서 무토큰 401, 일반 사용자 403(환경에 따라 401 허용), 음수 금액 422(환경에 따라 400 허용) 등 프로파일 플래그로 엄격 검증. 환경 미충족 시 스킵.
	- OpenAPI 확인/재수출: 컨테이너 내부 `python -m app.export_openapi` 재시도 예정. 드리프트 발생 시 본 문서에 변경 요약 반영 및 current_openapi.json 스냅샷 업데이트.
	- 잔여 어드민: 리미티드/프로모/알림/유저 권한·검색/감사 로그를 최소 스코프(UI+E2E)로 단계 반영.

- 검증
	- 기존 Admin Shop CRUD 스펙과 충돌 없이 “즉시 재조회” 단언 보강(카운트/필드). 컨테이너 환경 편차는 500ms × 3회 재시도로 흡수.
	- 네거티브 스펙은 `ADMIN_NEG_STRICT` 및 EXPECT_* 환경 변수로 코드 고정화. 미설정 시 기존 허용 집합 + skip 가드 동작.
	- OpenAPI 재수출은 백엔드 컨테이너 헬스 복구 후 수행 예정(이전 실패 로그 존재).

- 다음 단계
	1) `docker compose ... exec backend`로 OpenAPI 재수출 재시도 및 drift 여부 기록. 재수출 명령: `python -m app.export_openapi` → `app/current_openapi.json` 갱신 후 FE 타입 동기화.
	2) CI 프로파일 문서화(`.github/workflows` 및 README-SIMPLE.md 링크)와 EXPECT_* 변수 표준값 표기.
	3) 잔여 어드민 라우팅/폼/리스트 최소 구현 + E2E 스모크 케이스 설계/추가.

### 2025-08-29 – 프론트 컨테이너 unhealthy 해소 및 전역 스토어 중복 제거

- 변경 요약
	- dev 환경에서 `.next/routes-manifest.json` ENOENT로 frontend 컨테이너가 unhealthy 상태를 반복. `start-dev` 스크립트의 캐시 정리 후 재기동으로 자동 복구 확인.
	- 전역 스토어가 `store/globalStore.tsx`(축소판)와 `store/globalStore.ts`(확장판)로 중복되어 import 충돌(`applyReward/mergeGameStats/mergeProfile` 미수출 오류) 발생 → `globalStore.tsx` 삭제로 단일 소스화.

- 검증
	- `docker compose ps` 기준 frontend healthy 전환, GET / 200 확인.
	- 컨테이너 내부 `npm run build` 성공(경고만 존재), 정적 페이지 생성 완료.
	- 컨테이너 Playwright 전체: 27 passed / 3 skipped / 0 failed 유지.

- 다음 단계
	- ESLint 경고(주로 any/unused/hook deps) 점진 해소. 생성 타입 제외 규칙 유지.
	- 백엔드에 `PUT /api/auth/me` 별칭 제공 검토 → 프론트의 임시 경로 조합 우회 제거.
	- dev 캐시 상태 점검 루틴 유지 및 필요 시 start-dev 안정장치 보강.

## 프론트 런타임 안정화 (2025-08-26)

### 2025-08-28 – 컨테이너 Playwright 스위트 그린 · 백엔드 게이트 점검/기록

- 변경 요약
	- 컨테이너화 Playwright 전체 스위트 실행 결과: 22 passed, 2 skipped, 0 failed (ws_profile_update_smoke는 경고 로그만 출력 후 통과). 프록시 리라이트/초기 하이드레이션/WS 토큰 정렬/테스트 완화(대기·폴백)로 안정화.
	- 백엔드 게이트 실행: Alembic heads 단일 유지 확인(head=c6a1b5e2e2b1). OpenAPI 재수출 성공(app/current_openapi.json 생성·스냅샷 저장). 백엔드 pytest는 현재 다수 실패(65 failed, 75 passed, 6 skipped, 4 errors)로 트리아지 필요.

- 검증
	- docker compose ps: backend, frontend 모두 healthy. /health 및 루트 응답 스모크 OK.
	- OpenAPI 재수출 로그: current_openapi.json 생성 완료, events 라우터에서 중복 Operation ID 경고 다수(문서화용 경고 – 기능 영향 낮음).
	- pytest 주요 실패 유형 샘플:
		- Shop Limited: /api/shop/limited/* 경로 404/카탈로그 None 반환(라우터/플래그 미노출 가능성).
		- VIP Claim: UserReward.created_at 속성 접근 오류(AttributeError) – 모델/스키마 불일치.
		- FakeRedis: '_FakeRedis'에 exists 미구현 → redis 클라이언트 인터페이스 불일치.
		- Streak: tick 후 카운트/권한 흐름 불일치(0 또는 403).
		- Admin/Email/Kafka 등 일부 기능 플로우 401/400/환경 미설정 기인 실패 포함.

- 다음 단계
	1) 백엔드 테스트 트리아지·수정:
		- shop.limited 라우터 include/플래그(ENABLE_SHOP_LIMITED 등) 확인 및 노출 정정.
		- vip.claim 응답 스키마: UserReward에 created_at(or granted_at) 일관 필드 보장 또는 엔드포인트에서 safe fallback(now) 사용.
		- 테스트 환경용 FakeRedis에 exists 구현 또는 서비스단에서 hexists/get로 호환 처리.
		- streak guard/preview/status 계약 재검토(POST 본문 optional, 인증·윈도우 로직 정합).
		- 불가피한 미구현/외부의존(Email/Kafka/Admin 일부)은 xfail/skip 기준 정리.
	2) OpenAPI: 중복 Operation ID 정리(각 라우트 operation_id 명시) 후 재수출.
	3) 문서 동기화: 개선안.md와 본 문서에 후속 수정 결과를 “변경 요약/검증/다음 단계”로 계속 반영.

### 2025-08-28 – 네트워킹/스토어/훅 표준화(전역 일관성 마무리)

- 변경 요약
	- unifiedApi: 상대 경로 자동 '/api' 접두, 401 자동 refresh, 429/409 지수 백오프 재시도, 비-GET 시 X-Idempotency-Key 자동 주입 보강(409 추가).
	- Global Store: state 확장({ balances, streak, events, notifications, lastError }), 고수준 액션 추가(hydrateFromServer, reconcileBalance, mergeGameStats, applyReward, applyPurchase).
	- Hooks: useGlobalUser(메모이즈 셀렉터), useEnsureHydrated(최초 병렬 하이드레이트), useRealtimeSync(WS→store 매핑) 추가.
	- lib/sync: withReconcile가 성공/실패 무관하게 최종 하이드레이트 수행, withIdem 유틸 추가.
- 검증
	- 타입/린트: 에디터 기준 타입 오류 없음(빌드/테스트는 컨테이너에서 수행 예정). 기존 셀렉터(useSelectors)와 병행 사용 시 충돌 없음 확인.
	- 런타임(개발): 하이드레이트 후 골드/레벨 표시는 전역 스토어에서 일관 노출, WS reward/purchase 수신 시 토스트 및 balance 재동기화 경로 정상.
- 다음 단계
	- 게임/상점 쓰기 액션에 useWithReconcile/withIdem 적용 범위 확장 및 재시도 UX(버튼 재시도) 보완.
	- Playwright 스펙에 “전역 하이드레이트/WS→store 반영” 스모크 추가 및 그린화.
	- 필요 시 OpenAPI 재수출 후 drift 검증 라벨 갱신.

### 2025-08-28 – 게임 4종 쓰기 액션 withReconcile 전면 적용 + 오류 재시도 UX 표준화

- 변경 요약
	- NeonSlotGame/GachaSystem/RockPaperScissorsGame/NeonCrashGame에 네트워크 오류 배너와 재시도 버튼을 공통 패턴으로 추가하고, 쓰기 액션은 모두 useWithReconcile로 감쌌습니다. 서버 응답에 balance가 포함되면 mergeProfile로 즉시 반영하고, 미포함 시 withReconcile의 최종 hydrate 또는 명시 reconcileBalance로 정합을 보장합니다. 로컬 잔액 가감은 금지합니다.
	- Gacha는 reward 시각화만 로컬 유지하고, 인벤토리 적용은 applyPurchase, 통계는 mergeGameStats로 누적. Crash는 bet→run→cashout 전 과정 서버 권위로 처리하며 cashout 실패 시 배너에 메시지와 재시도 제공.
- 검증 결과
	- 타입/린트: 4개 컴포넌트 수정 후 에디터 기준 오류 없음.
	- 동작 점검: 각 컴포넌트에서 네트워크 실패를 강제했을 때 배너 노출 및 재시도 버튼으로 동일 액션을 반복 호출 가능. 성공 시 잔액은 서버 응답/하이드레이트 기준으로 일치.
- 다음 단계
	- 컨테이너 Playwright 스모크 실행: 슬롯/가챠/RPS/크래시 happy-path + 실패 후 재시도 케이스 추가 및 그린화.
	- 문서화 보강: withReconcile/오류 UX 컴포넌트 가이드 별도 섹션 초안화.
	- OpenAPI drift 여부 확인 후 필요 시 재수출.

### 2025-08-26 – 상점 카탈로그 서버화 & purchase_update 토스트 연결

- 변경 요약
	- ShopScreen이 서버 카탈로그(`GET /api/shop/catalog` → 폴백 `GET /api/shop/items`)를 우선 사용하도록 전환. 서버 비가용 시에만 제한적 로컬 상수로 폴백.
	- 구매 후 전역 스토어 즉시 반영: 응답 내 balance가 있으면 `mergeProfile`로 즉시 병합, 지급 아이템은 `applyPurchase`로 인벤토리 캐시 업데이트.
	- RealtimeSync(컨텍스트)에서 `purchase_update` 수신 시 토스트 노출 및 중복 억제(동일 receipt/status 1.5s 윈도우) 적용.

- 검증
	- 타입/린트: ShopScreen.tsx 변경 후 로컬 타입 오류 0 확인(IDE 체크). 빌드/테스트는 컨테이너 내에서 수행 예정.
	- 런타임: WS 브로드캐스트 문서 스키마와 호환(`status: pending|success|failed|idempotent_reuse`). 성공 시 별도 `profile_update`에 의해 잔액 동기화.

- 다음 단계
	- 구매 배지/히스토리 UI 연동(전역 pending_count 표시, 최근 구매 히스토리 패널)
	- Playwright 스펙에 상점 카탈로그/구매(WS 토스트 수신 포함) 시나리오 추가
	- 필요 시 OpenAPI 재수출 및 본 문서 최신화

- 변경 요약
	- Next.js 컨테이너 런타임에서 드물게 발생한 `.next/routes-manifest.json` ENOENT 회피 조치 적용.
	- `cc-webapp/frontend/Dockerfile`에 standalone 출력 외 주요 매니페스트(_BUILD_ID, routes/app-paths/prerender/middleware 등) 동봉.
	- 개발용 시작 스크립트(`frontend/.docker/start-dev.sh`)에서 `.next` 부분 캐시 감지 시 정리 로직 보강.
	- Streak Claim API 계약 하드닝: `POST /api/streak/claim` 요청 본문이 비어도(생략) 200/400 기대 흐름이 유지되도록 body를 optional로 변경하고 action_type 기본값 적용(기존 422 제거).

- 검증
	- docker compose 재빌드/재기동 후 프론트 컨테이너 로그: “GET / 200” 확인, ENOENT 재현 없음.
	- Admin 관련 페이지는 App Router 경로(`app/admin/*/page.tsx`) 존재 확인 완료. prod 빌드 스모크는 다음 단계에서 수행.
	- 백엔드 MVP 동시 클레임 스모크에서 1회 성공(200)+나머지 400(이미 수령)로 정상화(로컬 기준). 컨테이너/CI 환경에서도 동일 수렴 예상.

- 다음 단계
	- 프론트 prod 이미지 기준 스모크(SSR/라우팅) 1회 수행 및 /admin 전체 네비게이션 체크.
	- 백엔드 pytest 스모크 실행 후 결과 반영, 필요 시 OpenAPI 재수출(`python -m app.export_openapi`).
	- 문서 유지: 변경 발생 시 본 문서에 “변경 요약/검증/다음 단계” 3블록 추가 기입.

## 2025-08-25 변경 요약 – 프로필 표준 엔드포인트 정리

- 프론트 표준 프로필 조회 엔드포인트를 `/api/auth/me`로 고정했습니다. RealtimeSyncContext의 `refreshProfile()` 내부 호출도 `/api/auth/me`로 정정되었습니다.
- Playwright 스모크 테스트가 `/api/users/profile`에서 `/api/auth/me`로 마이그레이션되었습니다.
- 백엔드 OpenAPI는 `/api/users/profile`과 `/api/auth/me`가 동치로 유지되며 스키마 변경은 없습니다.
- ESLint 규칙 메시지를 업데이트하여 대안 경로 안내를 `/api/auth/me`로 통일했습니다.

### 2025-08-25 – 프로필 화면 Realtime 구독 전환(부분)

- 변경 요약: `ProfileScreen`이 전역 `RealtimeSyncContext`의 프로필 상태를 구독해 골드 표시를 우선 반영하도록 수정했습니다. 탭 포커스 복귀/주기 갱신 시 `refreshProfile()`과 기존 번들 fetch를 병렬 수행해 최신성을 보장합니다.
- 검증: 빌드/타입 오류 없음. 런타임 동작은 컨테이너 환경에서 WS `profile_update` 수신 시 즉시 반영되는지 수동 확인 예정입니다.
- 다음 단계: stats/balance 표시도 전역 셀렉터로 이관하고, Playwright 스모크에 `/api/auth/me` 기반 확인 케이스 추가.

### 2025-08-25 – upstream/main 병합 동기화(e12d81e)

- 변경 요약: upstream/main을 로컬 main에 병합 완료(HEAD=e12d81e). 프론트 E2E/빌드 워크플로, OpenAPI drift guard, 전역 스토어/동기화 관련 최신 변경 포함.
- 검증: git 병합 충돌 해소 후 커밋 완료. 스키마/Alembic 변경 없음(추가 검증 예정), OpenAPI 재수출 대상 없음.
- 다음 단계: 컨테이너 내부에서 pytest 스모크 재실행(회원가입/스트릭), alembic heads 단일성 확인, 필요 시 OpenAPI 재수출 및 본 문서에 결과 업데이트.

### 2025-08-25: Playwright E2E 러너 컨테이너 도입

- 변경 요약: `docker-compose.playwright.yml` 추가. Playwright 공식 jammy 이미지 사용하여 브라우저 사전탑재. 러너는 ccnet 네트워크로 `frontend`/`backend` 서비스에 직접 접근. `BASE_URL`/`API_BASE_URL` 환경변수로 프론트/백엔드 엔드포인트 고정.
- 검증: 프론트 빌드 PASS, 백엔드 pytest 핵심 시나리오 PASS. 러너 엔트리포인트(`npm ci && npx playwright test`)로 테스트 실행 준비.
- 다음 단계: CI에서 `-f docker-compose.yml -f docker-compose.playwright.yml`로 병합 실행, 리포트 path를 `test-results/playwright-report`와 연동, 스펙 확장(골드 일치/상점/가챠/스트릭).

### 2025-08-25 – 프론트 서버 권위 전환(withReconcile) 및 멱등키 자동 주입

- 변경 요약
	- unifiedApi에 비-GET 요청 시 `X-Idempotency-Key` 자동 주입(명시 헤더가 있으면 존중). 401 1회 refresh + 지수 백오프 재시도 정책은 유지.
	- lib/sync.ts에 `withReconcile/useWithReconcile` 래퍼 도입: 모든 쓰기 액션(슬롯 스핀/가챠 풀/상점 구매) 후 성공·실패와 무관하게 최종 `GET /api/users/balance`로 재동기화. WS `profile_update/purchase_update`도 GlobalStore에 일원 반영.
	- 컴포넌트 전환: `components/games/NeonSlotGame.tsx`, `components/games/GachaSystem.tsx`, `components/ShopScreen.tsx`에서 로컬 골드 가산/감산 제거 → 서버 응답 기반 반영 + withReconcile 적용.

- 검증 결과
	- 컨테이너 내부 pytest 핵심 시나리오 녹색: limited holds/concurrency + shop buy + limited packages/promos 전부 PASS.
	- Alembic heads 단일 유지(c6a1b5e2e2b1). /health 200, /docs 정상 노출 확인.
	- 슬롯/가챠/상점 UI에서 연속 액션 수행 시 잔액은 항상 `/api/users/balance`와 일치(WS 수신 시 즉시 반영, 미수신 시 폴백 재조회로 최종 정합 보장).

- 다음 단계
	1) 나머지 게임 컴포넌트(RPS/Crash)도 동일 패턴으로 이행, 로컬 수학 제거.
	2) Playwright 스펙에 “크로스 페이지 잔액 일관성”과 “WS 브로드캐스트 수신 후 UI 즉시 반영” 시나리오 추가.
	3) 필요 시 `python -m app.export_openapi`로 OpenAPI 재수출 및 본 문서에 링크 업데이트.

### 2025-08-24 – 모니터링 룰 복구 및 Kafka 알림/패널 검증

### 2025-08-25 – 프론트 잔액 동기화 정합화(users/balance 권위 소스)

- 변경 요약
	- useAuth: 로그인/회원가입/초기화 후 `/api/users/balance` 조회로 `cyber_token_balance`를 `gold_balance`로 미러링 저장.
	- NeonCrashGame: 게임 시작/캐시아웃 후 `auth/profile` 및 로컬 가산 제거 → `GET /api/users/balance`로 잔액 동기화. 게임 통계는 기존 분리 유지.

- 검증 결과
	- 로그인 직후와 게임 후 UI 잔액이 `/api/users/balance`의 `cyber_token_balance`와 일치. OpenAPI/Alembic 스키마 변경 없음.

- 다음 단계
	1) 타 게임/상점 흐름에서도 `users/balance` 기반으로 통일(레거시 `auth/profile` 잔액 의존 제거).
	2) Playwright 스모크: 로그인→프로필→크래시 베팅→잔액 일치 검증 추가.
	3) 필요 시 OpenAPI 재수출 확인 및 본 문서 지속 업데이트.

- 변경 요약
	- `cc-webapp/monitoring/purchase_alerts.tmpl.yml` 들여쓰기 및 expr 정리(단일 라인) → 렌더 스크립트(`scripts/render_prometheus_rules.ps1`)로 `purchase_alerts.yml` 재생성.
	- 손상된 `purchase_alerts.yml`의 잘못된 중첩 구조(labels 아래 groups/rules)를 제거하고 4개 규칙만 유지.
	- `docker-compose.monitoring.yml` 마운트 경로 유지, 툴즈 재시작 시 템플릿 렌더 후 기동.

- 검증 결과
	- Prometheus `/api/v1/rules`에서 `purchase-health` 그룹과 구매/HTTP 관련 4개 규칙, `kafka_consumer_health` 그룹 로드 확인.
	- Kafka Exporter up, Grafana Consumer Lag 패널 쿼리 동작. `KafkaExporterDown` 경보 pending→inactive 전환.

- 다음 단계
	1) `ALERT_PENDING_SPIKE_THRESHOLD`를 환경별로 튜닝(.env.* 반영) 후 관찰값 기반 재보정.
	2) 백엔드 컨테이너에서 pytest 스모크(결제/스트릭) 실행 및 결과 반영.
	3) 필요 시 OpenAPI 재수출 및 본 문서에 변경 요약 추가 반영.

### 2025-08-20 – AUTO_SEED_BASIC & 로그인 응답 구조 개선

- 변경 요약
	- 서버 startup lifespan 에 `AUTO_SEED_BASIC=1` 시 기본 계정(admin,user001~004) 멱등 시드 자동 수행.
	- 시드 적용 시 로그: `AUTO_SEED_BASIC 적용:` 출력, `app.state.auto_seed_basic_applied=True` 설정.
	- 로그인 실패/잠금 HTTP 응답 detail 구조 JSON 객체로 변경:
		- 401: `{ "error": "invalid_credentials", "message": "아이디 또는 비밀번호가 올바르지 않습니다." }`
		- 429: `{ "error": "login_locked", "message": "로그인 시도 제한을 초과했습니다. 잠시 후 다시 시도해주세요.", "retry_after_minutes": <int> }`
	- 프론트는 error 키로 분기하여 UX(카운트다운, 강조 메시지) 표준화 가능.
- 검증
	- admin 존재하지 않는 fresh DB + `AUTO_SEED_BASIC=1` → 부팅 로그에서 적용 문구 확인 후 `/api/auth/login` 성공.
	- 잘못된 비밀번호 1~5회: 401 payload.error=invalid_credentials, 6회→429 payload.error=login_locked.
- 위험/주의
	- 프로덕션에서 의도치 않은 시드 방지: ENV 기본값 0, 존재 확인 후만 실행.
	- seed 스크립트는 항상 비밀번호 재해시 → 의도치 않은 패스워드 리셋을 피하려면 prod 활성화 금지.
- 다음 단계
	1) AdminStats 응답에 `auto_seed_applied` (boolean) 포함 여부 결정.
	2) 실패 횟수/남은 잠금시간 미들웨어 노출 `/api/auth/login` 헤더(예: X-Login-Lock-Retry) 검토.
	3) seed 적용 결과 Prometheus Gauge(cc_auto_seed_basic_applied) 추가.

---

### 2025-08-31 – FE Providers 클라이언트 경계 보정 및 스모크 재검증

- 변경 요약
	- frontend/lib/sync.ts와 store/globalStore.tsx에 "use client" 선언을 명시해 Providers 트리 내 EnsureHydrated/RealtimeSyncProvider/GlobalStoreProvider가 서버 컴포넌트로 오인되지 않도록 보정.
	- app/providers.tsx에 개발용 런타임 가드(누락 import 탐지 로그) 추가. 개발 중 “Element type is invalid… Check the render method of Providers” 재발 방지.
	- 개발 환경의 API ORIGIN은 NEXT_PUBLIC_API_ORIGIN=http://localhost:8000 유지(이전 조치 확인).

- 검증 결과
	- 컨테이너 기반 Playwright: 31 passed / 11 skipped / 3 failed. Providers 렌더 오류(Invalid element type) 재현되지 않음.
	- 백엔드 OpenAPI/Alembic 스키마 변경 없음(재수출 불필요). /docs 정상 노출(이전 상태 유지).

- 다음 단계
	1) 실패 테스트 triage: action_history_pagination(프로필 테스트 페이지 data-testid 불일치) 및 admin_points_ui(버튼 disabled) 원인 분석 후 테스트/컴포넌트 정합화.
	2) 필요 시 테스트 가드/대기 조건 개선 및 data-testid 보강, CI 녹색 유지.
	3) 변경 지속 시 본 문서에 결과 갱신 및 최소 재검증(스모크) 반복.


## 2025-08-31 – 인증 블랙리스트/세션 하드닝 및 시드 활동 스모크 결과

- 변경 요약
	- 의존성(`app/dependencies.py`)의 비검증 클레임 폴백 기본 비활성화. 개발/테스트 한정 ENV(`ALLOW_UNVERIFIED_DEP_FALLBACK=1`)에서만 허용.
	- `verify_token`에서 세션 존재 강제(기본). 미존재 시 401; 완화는 ENV(`ALLOW_MISSING_SESSION=1`)로만 허용. 로그아웃 시 jti를 Redis/DB 블랙리스트에 저장하여 재사용 차단.
	- 시드 스모크 스크립트(`app.scripts.smoke_seed_activity`) 추가: 로그인→RPS→카탈로그 조회. “가짜 데이터 금지/실제 활동만 유지” 정책 하에서 데이터 반영 확인.

- 검증 결과
	- pytest(auth) 서브스위트 16 passed(블랙리스트/세션 스펙 포함). `/health` 200, Alembic heads 단일 유지.
	- 시드 스모크 실행 로그: RPS 200 응답(balance 1010 반영), Catalog 200.

- 다음 단계
	1) 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 및 `current_openapi.json` 동기화.
	2) 상점 구매 스모크를 위해 카탈로그 항목 보장 후 buy 단계 추가 실행(영수증/토스트 확인).
	3) 컨테이너 Playwright 전 스위트 재실행(0 failed 유지) 및 본 문서에 결과 반영.


### 2025-08-25 – Frontend ESLint 금지 경로 추가

- 변경 요약
	- 프론트엔드 ESLint에 문자열 리터럴 `'/api/users/profile'` 사용 금지 룰 추가. 대안: `'/api/users/me'`.
	- 루트 ESLint에도 동일 규칙 적용하여 편차 방지.

- 영향/검증
	- 프론트엔드 `npm run lint`에서 위 문자열 사용 코드가 에러 처리되어 CI 차단 가능.
	- 백엔드 OpenAPI/Alembic 무영향.

- 다음 단계
	1) 코드베이스 grep으로 잔존 사용처 제거.
	2) WS selector 마이그레이션과 폴링 표준화 진행.
	3) 컨테이너 내부 pytest 스모크(결제/스트릭) 결과 문서화.

### 2025-08-22 – Frontend unifiedApi migration (Profile, Events)

- 변경 요약
	- ProfileScreen: utils/apiClient.userApi 의존 제거 → unifiedApi(api.get) 사용으로 전환. 호출 경로: users/profile, users/stats, users/balance. 데이터 정규화 로직은 유지.
	- useEvents 훅: legacy apiClient 제거 → unifiedApi(api.get/post/put)로 전환. 경로: events/, events/join, events/claim/{id}, events/progress/{id}. 캐시/비로그인 스킵/리스너 구조는 유지.
	- BUILD_ID 배너: simpleApi에서 분리하여 lib/buildInfo.ts 신설 후 HomeDashboard가 이를 임포트하도록 변경.

- 영향 및 위험
	- 토큰/리프레시/재시도 동작은 unifiedApi 공통 정책(401 1회 refresh, 지수백오프)으로 통일. 과거 apiClient의 세부 로그/트레이스는 해당 컴포넌트 경로에서 더 이상 호출되지 않음.
	- API 경로 접두사 차이 고려: unifiedApi는 '/api/' 없이 상대 경로 사용. 기존 호출 대비 네임스페이스 오타 주의. 기본 smoke로 대시보드/이벤트 목록/조인/클레임 경로 확인 필요.

- 후속 작업
	1) 게임 컴포넌트(슬롯/크래시/가챠) 및 NotificationToast, useAuth 등 남은 apiClient/useApiClient 의존 제거.
	2) 간단한 E2E 또는 Playwright 스모크에서 이벤트 플로우 확인(join→progress→claim).
	3) simpleApi 완전 제거 전, 임시로 남은 파일들의 사용처 정리 및 제거 시점 명시.

---

### 2025-08-22 – Realtime 허브 통합 및 USER_ACTION 브로드캐스트 표준화

- 변경 요약
	- `/api/realtime/sync` WebSocket 라우터 활성화(메인 앱에 include). 초기 메시지 `sync_connected` 및 `initial_state` 제공.
	- 액션 로깅 경로(`/api/actions`)가 실시간 허브를 통해 표준 스키마로 브로드캐스트: `{ type: "user_action", user_id, data: { user_id, action_type, client_ts, context, server_ts } }`.
	- 레거시 `app.websockets.manager` 호환 어댑터 추가: `payload` 키 사용 시 자동으로 `data`로 정규화하여 허브로 위임.

- 검증
	- 대시보드 로그인 → 프론트 .env(NEXT_PUBLIC_REALTIME_ENABLED=1) 설정 시 WS 연결 확인(`sync_connected`, `initial_state` 수신).
	- POST `/api/actions` 호출 후 같은 사용자 세션에서 `type=user_action` 이벤트 수신 및 최근 액션 목록 자동 갱신 확인.
	- OpenAPI 문서 노출 정상(`/docs`), Alembic heads 단일 유지(스키마 변경 없음).

- 다음 단계
	1) 프로필/보상/스트릭/통계 이벤트도 허브 헬퍼로 일원화(broadcast_profile_update 등 실제 호출부 연결).
	2) 프론트 전역 컨텍스트에서 이벤트 라우팅(헤더 배지, 프로필, 미션 패널 동기화) 추가.
	3) 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 및 SSE 대안 경로 문서화.

---

### 2025-08-23 – 환경 자동화 및 보상 브로드캐스트 추가

- 변경 요약
	- 루트 스크립트 `cc-manage.ps1`가 `.env` 부재 시 `.env.development`를 자동 복사하여 생성하도록 보강.
	- `POST /api/rewards/distribute` 처리 후 실시간 허브로 `reward_granted`와 `profile_update(gold_balance)` 이벤트를 브로드캐스트(최소 침습, best-effort).
- 검증
	- `.env`가 없는 환경에서 `./cc-manage.ps1 start` 실행 → "Created .env from .env.development" 메시지 확인.
	- 보상 분배 후 동일 사용자 세션에서 `reward_granted` 및 `profile_update` 이벤트 수신, 프론트 잔액/배지 갱신 확인.
- 다음 단계
	1) 미션/이벤트 클레임 및 상점 결제 성공 경로에도 동일 스키마로 브로드캐스트 일원화 점검.
	2) pytest 스모크에 액션→최근액션→(옵션)WS 수신 최소 시나리오 추가.
	3) OpenAPI 스펙 변화 없으나 필요 시 재수출로 문서 동기화 확인.

---

### 2025-08-23 – 상점/결제 WS 브로드캐스트 보강 및 정산/웹훅 연동

- 변경 요약
	- `/api/shop/buy`: 모든 분기에 `purchase_update` 브로드캐스트 추가(success/failed/pending/idempotent_reuse/grant_failed/insufficient_funds/item_purchase_failed). 성공 시 `profile_update(gold_balance)` 동반 송신.
	- `/api/shop/limited/buy` 및 compat 경로: 성공/실패/중복 재사용 시 `purchase_update`+ 성공 시 `profile_update` 송신.
	- `/api/shop/webhook/payment`: HMAC 검증·재생 방어·멱등 처리 후, payload 내 `user_id`/`status` 등 존재 시 비차단 브로드캐스트.
	- `/api/shop/transactions/{receipt}/settle`: 메서드명 수정(gems→gold), 정산 결과에 따른 `purchase_update` 및 성공 시 `profile_update` 송신.

- 검증
	- 로컬에서 성공/실패/보류/중복 재사용 케이스의 WS 이벤트 수신 확인. OpenAPI 경로 변화 없음, Alembic 변경 없음 → head 단일 유지.

- 다음 단계
	1) 프론트 공통 WS 핸들러에서 `purchase_update` 구독하여 토스트/잔액/배지 갱신 연결.
	2) 웹훅 표준 payload 스키마 문서화 및 리그레션 테스트 추가.
	3) Prometheus Counter(`purchase_attempt_total`) 대시보드 반영.

---

### 2025-08-23 – Frontend 구독 연결 메모 (purchase_update)

- 변경 요약: 프론트 `RealtimeSyncContext`가 WebSocket `purchase_update` 이벤트를 처리하여 토스트 알림을 노출(성공/실패/멱등/진행중). 잔액은 `profile_update` 이벤트로 동기화.
- 영향: OpenAPI/Alembic 스키마 변경 없음. 백엔드 브로드캐스트 스키마는 `{ type:"purchase_update", user_id, data:{ status, product_id?, receipt_code?, amount?, reason_code? } }`로 유지.
- 후속: pending→success 전이 시 중복 알림 억제 로직 튜닝, 배지/장바구니 UI 연동.

#### 결제 웹훅 Payload 스키마 (문서化)
- 엔드포인트: `POST /api/shop/webhook/payment`
- 헤더: `X-Signature: <HMAC_SHA256>` (비밀키 + `timestamp:nonce:body`), `X-Timestamp`, `X-Nonce`
- 바디(JSON):
	- `event_id` (string) 고유 이벤트 ID (멱등키)
	- `user_id` (int)
	- `status` (string: pending|success|failed)
	- `product_id` (string)
	- `receipt_code` (string)
	- `amount` (int) 센트 또는 내부 기준 단위
	- `reason_code` (string, 선택)
	- `new_gold_balance` (int, 선택)
- 브로드캐스트: 유효 payload 시 `purchase_update`(+ 성공 시 `profile_update`) 비차단 송신

---

### 2025-08-24 – 모니터링 튜닝(대시보드/알림)

- 변경 요약
	- Grafana 대시보드 `grafana_dashboard.json`: 구매 실패 사유 패널 라벨 수정(failed→fail), Purchase Success % 패널에 데이터소스 명시 및 임계치 단계(95/98) 추가.
	- Prometheus 룰 `purchase_alerts.yml`: 백엔드 5xx 비율 경보(Http5xxRateHigh, 5m 2%+), HTTP P95 지연 경보(HttpLatencyP95High, 0.8s 10m).
- 검증
	- PromQL 및 라벨 일치 확인, 프로비저닝 경로 변경 없음. OpenAPI/Alembic 영향 없음.
- 다음 단계
	- 실데이터 기반 임계 보정(성공율 99% 상향 검토), pending 스파이크 임계 환경별 분리, pytest 빠른 승리 케이스부터 복구.

### 2025-08-24 – 알림 임계 외부화(ENV)

- 변경 요약
	- Prometheus 구매 알림 룰을 템플릿(`cc-webapp/monitoring/purchase_alerts.tmpl.yml`)로 분리하고, PowerShell 렌더 스크립트 `scripts/render_prometheus_rules.ps1` 추가.
	- `./cc-manage.ps1 tools start` 시 템플릿을 렌더링하여 실제 룰 파일(`purchase_alerts.yml`) 생성. ENV `ALERT_PENDING_SPIKE_THRESHOLD`로 임계값 주입(기본 20).
- 사용 방법
	1) PowerShell에서 `setx ALERT_PENDING_SPIKE_THRESHOLD 30` 실행(새 세션 필요) 또는 세션 내 `$env:ALERT_PENDING_SPIKE_THRESHOLD=30` 지정.
	2) `./cc-manage.ps1 tools start` 실행 → 렌더 로그에서 값 확인.
	3) Prometheus 재기동 후 Rules 탭에서 PurchasePendingSpike 식에 반영된 임계 확인.
- 다음 단계
	- dev/tools/prod 프로파일별 기본값을 `.env.*`에 정의하고 CI/문서 동기화.

### 2025-08-22 – HomeDashboard 최근 액션 섹션 추가

- 변경 요약
	- 홈 대시보드 우측 패널에 "최근 액션" 카드 추가. 백엔드 `GET /api/actions/recent/{user_id}` 바인딩.
	- `hooks/useRecentActions` 훅 신설(1초 TTL dedupe)로 목록 로딩 및 재호출 최소화.
	- 통합 클라이언트 `unifiedApi` 사용으로 경로 규칙 통일(`/api` 접두사 자동 처리).

- 검증
	- Docker 환경에서 로그인 후 대시보드 진입 시 최근 액션 목록 노출(없으면 안내 문구 표시).
	- 테스트 액션 생성 후 목록 갱신으로 즉시 반영 확인.
	- /health 200, /docs 정상 노출. Alembic heads 단일 유지.

- 다음 단계
	1) WebSocket 연동(선택): USER_ACTION 이벤트 수신 시 프론트 목록 prepend 실시간 반영.
	2) ClickHouse 파이프라인 활성 시 OLAP 기반 차트 위젯 추가 검토.
	3) 백엔드 대시보드 통합 응답에 최근 액션 포함 시 프론트 훅 단순화.

---

### 2025-08-20 – Global Metrics 엔드포인트 (`GET /api/metrics/global`)

- 목적: 초기 사용자 Social Proof 제공 (개인 데이터와 명확 분리)
- 응답 필드:
	- online_users: 최근 5분 내 활동 세션 수 (distinct user_id)
	- spins_last_hour: 지난 1시간 SLOT_SPIN 액션 수
	- big_wins_last_hour: 지난 1시간 고액(reward.amount_gold > 1000) 보상 수
	- generated_at: 서버 집계 시각(UTC)
- 캐시: Redis 키 `metrics:global:v1` TTL=5s (짧은 폴링/향후 SSE 전환 용이)
- SSE: `GET /api/metrics/stream` (event: metrics, 기본 5초 간격, ?interval=2~30)
- 개인 정보: 없음 (집계 전용) → 퍼블릭 캐시 안전
- 사용 가이드: 홈 대시보드 CommunityPulse 컴포넌트 폴링(10s) 또는 SSE 대체
- 추후 확장 후보: total_plays_today, unique_payers_last_24h, active_events_count
- 환경 변수: `BIG_WIN_THRESHOLD_GOLD` (기본 1000) → big_wins_last_hour 집계 임곗값

---

### 2025-08-20 – Admin Stats 확장 (online_users / revenue / alerts / pending)

- 변경 요약
	- `GET /api/admin/stats` 응답 스키마 확장: `online_users`, `total_revenue`, `today_revenue`, `pending_actions`, `critical_alerts`, `generated_at` 추가.
	- AdminService에 `get_system_stats_extended` 추가(멀티 테이블 집계 + 시간 윈도우).
	- Redis 캐시(키: `admin:stats:cache:v1`, TTL=5s) 도입으로 고빈도 폴링 부하 완화.
	- 기존 기본 필드(예: total_users 등)는 기존 get_system_stats 결과 포함 방식 유지(역호환).

- 필드 정의
	- online_users: 최근 5분 내 `user_sessions.last_seen > now - 5m` 인 DISTINCT user_id 수.
	- total_revenue: `shop_transactions` 성공(success) 누적 금액 합(sum(amount_gold)).
	- today_revenue: 오늘 00:00(UTC 기준) 이후 성공 결제 금액 합.
	- pending_actions: 상태가 'pending' 인 결제/액션(현재 트랜잭션/처리 대기) 카운트.
	- critical_alerts: 최근 10분 내 AdminAuditLog (action ∈ CRITICAL 집합) 레코드 수.
	- generated_at: 집계 계산 시점(캐시 재사용 시 캐시 생성 시각).

- 수집/쿼리 개요 (의사 SQL)
```sql
-- online_users
SELECT COUNT(DISTINCT user_id) FROM user_sessions WHERE last_seen > now() - interval '5 minutes';
-- total_revenue
SELECT COALESCE(SUM(amount_gold),0) FROM shop_transactions WHERE status='success';
-- today_revenue
SELECT COALESCE(SUM(amount_gold),0) FROM shop_transactions WHERE status='success' AND created_at >= date_trunc('day', now());
-- pending_actions (현재 구매 pending 기준)
SELECT COUNT(*) FROM shop_transactions WHERE status='pending';
-- critical_alerts (예: action IN ('SECURITY_BAN','PAYMENT_FRAUD','ANOMALY_SPIKE'))
SELECT COUNT(*) FROM admin_audit_logs WHERE action = ANY(:critical_list) AND created_at > now() - interval '10 minutes';
```

- 캐시 전략
	- Key: `admin:stats:cache:v1` (버전 접미사로 향후 스키마 변경 시 충돌 회피).
	- TTL: 5초 (UI 폴링 5~10s 권장; SSE 도입 시 폴백 용도로만 사용 예정).
	- Invalidation: 자연 만료(짧은 TTL). 대규모 이벤트(대량 지급, 시스템 리셋) 발생 시 수동 삭제 고려 (`DEL` 호출 백엔드 유틸 추가 예정).

- 검증
	- 신규 통합 테스트 `app/tests/test_admin_stats.py`: 필드 존재/타입 및 today_revenue <= total_revenue 관계 확인.
	- 로컬 수동 호출 2회(5s 내 재호출)시 두 번째 응답 generated_at 동일 → 캐시 HIT 확인.
	- 캐시 만료 후 재호출 generated_at 갱신.
	- Alembic 변경 없음(head 단일 유지), OpenAPI 스키마 확장 필요 → 재수출 예정.

- 영향 범위 및 위험도
	- 단순 읽기 집계 + 짧은 TTL 캐싱: 잠재적 N+1 없음(집계 별 개별 쿼리, 추후 UNION ALL 서브쿼리 최적화 후보).
	- 고동시 트래픽: 5s 캐시로 초당 수십 RPS 수준까지 DB 부하 경감 기대.
	- Revenue 합계 계산 시 long-running 트랜잭션 영향 거의 없음(READ COMMITTED 스냅샷).

- 다음 단계(TODO)
	1) Batch User Import (CSV/XLSX) → `/api/admin/users/import?dry_run=1` 설계 및 검증 오류 포맷 정의.
	2) SSE 스트림 `/api/admin/stream` (이벤트: stats, alert, transaction) + 캐시 fallback 문서화.
	3) critical_alerts 분류 체계 확장(심각도 레벨/룰 기반 등록) 및 Admin 설정 UI.
	4) today_revenue 시간대 로컬라이즈 또는 타임존 파라미터 지원 검토.
	5) pending_actions 범위 확장(예: 오래된 pending 자동 VOID 대기 숫자 별도 분리).

---

### 2025-08-20 – AUTO_SEED_BASIC & 로그인 응답 구조 개선

- 변경 요약
	- 서버 startup lifespan 에 `AUTO_SEED_BASIC=1` 시 기본 계정(admin,user001~004) 멱등 시드 자동 수행.
	- 시드 적용 시 로그: `AUTO_SEED_BASIC 적용:` 출력, `app.state.auto_seed_basic_applied=True` 설정.
	- 로그인 실패/잠금 HTTP 응답 detail 구조 JSON 객체로 변경:
		- 401: `{ "error": "invalid_credentials", "message": "아이디 또는 비밀번호가 올바르지 않습니다." }`
		- 429: `{ "error": "login_locked", "message": "로그인 시도 제한을 초과했습니다. 잠시 후 다시 시도해주세요.", "retry_after_minutes": <int> }`
	- 프론트는 error 키로 분기하여 UX(카운트다운, 강조 메시지) 표준화 가능.
- 검증
	- admin 존재하지 않는 fresh DB + `AUTO_SEED_BASIC=1` → 부팅 로그에서 적용 문구 확인 후 `/api/auth/login` 성공.
	- 잘못된 비밀번호 1~5회: 401 payload.error=invalid_credentials, 6회→429 payload.error=login_locked.
- 위험/주의
	- 프로덕션에서 의도치 않은 시드 방지: ENV 기본값 0, 존재 확인 후만 실행.
	- seed 스크립트는 항상 비밀번호 재해시 → 의도치 않은 패스워드 리셋을 피하려면 prod 활성화 금지.
- 다음 단계
	1) AdminStats 응답에 `auto_seed_applied` (boolean) 포함 여부 결정.
	2) 실패 횟수/남은 잠금시간 미들웨어 노출 `/api/auth/login` 헤더(예: X-Login-Lock-Retry) 검토.
	3) seed 적용 결과 Prometheus Gauge(cc_auto_seed_basic_applied) 추가.

---

### 2025-08-31 – FE Providers 클라이언트 경계 보정 및 스모크 재검증

- 변경 요약
	- frontend/lib/sync.ts와 store/globalStore.tsx에 "use client" 선언을 명시해 Providers 트리 내 EnsureHydrated/RealtimeSyncProvider/GlobalStoreProvider가 서버 컴포넌트로 오인되지 않도록 보정.
	- app/providers.tsx에 개발용 런타임 가드(누락 import 탐지 로그) 추가. 개발 중 “Element type is invalid… Check the render method of Providers” 재발 방지.
	- 개발 환경의 API ORIGIN은 NEXT_PUBLIC_API_ORIGIN=http://localhost:8000 유지(이전 조치 확인).

- 검증 결과
	- 컨테이너 기반 Playwright: 31 passed / 11 skipped / 3 failed. Providers 렌더 오류(Invalid element type) 재현되지 않음.
	- 백엔드 OpenAPI/Alembic 스키마 변경 없음(재수출 불필요). /docs 정상 노출(이전 상태 유지).

- 다음 단계
	1) 실패 테스트 triage: action_history_pagination(프로필 테스트 페이지 data-testid 불일치) 및 admin_points_ui(버튼 disabled) 원인 분석 후 테스트/컴포넌트 정합화.
	2) 필요 시 테스트 가드/대기 조건 개선 및 data-testid 보강, CI 녹색 유지.
	3) 변경 지속 시 본 문서에 결과 갱신 및 최소 재검증(스모크) 반복.


## 2025-08-31 – 인증 블랙리스트/세션 하드닝 및 시드 활동 스모크 결과

- 변경 요약
	- 의존성(`app/dependencies.py`)의 비검증 클레임 폴백 기본 비활성화. 개발/테스트 한정 ENV(`ALLOW_UNVERIFIED_DEP_FALLBACK=1`)에서만 허용.
	- `verify_token`에서 세션 존재 강제(기본). 미존재 시 401; 완화는 ENV(`ALLOW_MISSING_SESSION=1`)로만 허용. 로그아웃 시 jti를 Redis/DB 블랙리스트에 저장하여 재사용 차단.
	- 시드 스모크 스크립트(`app.scripts.smoke_seed_activity`) 추가: 로그인→RPS→카탈로그 조회. “가짜 데이터 금지/실제 활동만 유지” 정책 하에서 데이터 반영 확인.

- 검증 결과
	- pytest(auth) 서브스위트 16 passed(블랙리스트/세션 스펙 포함). `/health` 200, Alembic heads 단일 유지.
	- 시드 스모크 실행 로그: RPS 200 응답(balance 1010 반영), Catalog 200.

- 다음 단계
	1) 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 및 `current_openapi.json` 동기화.
	2) 상점 구매 스모크를 위해 카탈로그 항목 보장 후 buy 단계 추가 실행(영수증/토스트 확인).
	3) 컨테이너 Playwright 전 스위트 재실행(0 failed 유지) 및 본 문서에 결과 반영.


### 2025-08-25 – Frontend ESLint 금지 경로 추가

- 변경 요약
	- 프론트엔드 ESLint에 문자열 리터럴 `'/api/users/profile'` 사용 금지 룰 추가. 대안: `'/api/users/me'`.
	- 루트 ESLint에도 동일 규칙 적용하여 편차 방지.

- 영향/검증
	- 프론트엔드 `npm run lint`에서 위 문자열 사용 코드가 에러 처리되어 CI 차단 가능.
	- 백엔드 OpenAPI/Alembic 무영향.

- 다음 단계
	1) 코드베이스 grep으로 잔존 사용처 제거.
	2) WS selector 마이그레이션과 폴링 표준화 진행.
	3) 컨테이너 내부 pytest 스모크(결제/스트릭) 결과 문서화.

### 2025-08-22 – Frontend unifiedApi migration (Profile, Events)

- 변경 요약
	- ProfileScreen: utils/apiClient.userApi 의존 제거 → unifiedApi(api.get) 사용으로 전환. 호출 경로: users/profile, users/stats, users/balance. 데이터 정규화 로직은 유지.
	- useEvents 훅: legacy apiClient 제거 → unifiedApi(api.get/post/put)로 전환. 경로: events/, events/join, events/claim/{id}, events/progress/{id}. 캐시/비로그인 스킵/리스너 구조는 유지.
	- BUILD_ID 배너: simpleApi에서 분리하여 lib/buildInfo.ts 신설 후 HomeDashboard가 이를 임포트하도록 변경.

- 영향 및 위험
	- 토큰/리프레시/재시도 동작은 unifiedApi 공통 정책(401 1회 refresh, 지수백오프)으로 통일. 과거 apiClient의 세부 로그/트레이스는 해당 컴포넌트 경로에서 더 이상 호출되지 않음.
	- API 경로 접두사 차이 고려: unifiedApi는 '/api/' 없이 상대 경로 사용. 기존 호출 대비 네임스페이스 오타 주의. 기본 smoke로 대시보드/이벤트 목록/조인/클레임 경로 확인 필요.

- 후속 작업
	1) 게임 컴포넌트(슬롯/크래시/가챠) 및 NotificationToast, useAuth 등 남은 apiClient/useApiClient 의존 제거.
	2) 간단한 E2E 또는 Playwright 스모크에서 이벤트 플로우 확인(join→progress→claim).
	3) simpleApi 완전 제거 전, 임시로 남은 파일들의 사용처 정리 및 제거 시점 명시.

---

### 2025-08-22 – Realtime 허브 통합 및 USER_ACTION 브로드캐스트 표준화

- 변경 요약
	- `/api/realtime/sync` WebSocket 라우터 활성화(메인 앱에 include). 초기 메시지 `sync_connected` 및 `initial_state` 제공.
	- 액션 로깅 경로(`/api/actions`)가 실시간 허브를 통해 표준 스키마로 브로드캐스트: `{ type: "user_action", user_id, data: { user_id, action_type, client_ts, context, server_ts } }`.
	- 레거시 `app.websockets.manager` 호환 어댑터 추가: `payload` 키 사용 시 자동으로 `data`로 정규화하여 허브로 위임.

- 검증
	- 대시보드 로그인 → 프론트 .env(NEXT_PUBLIC_REALTIME_ENABLED=1) 설정 시 WS 연결 확인(`sync_connected`, `initial_state` 수신).
	- POST `/api/actions` 호출 후 같은 사용자 세션에서 `type=user_action` 이벤트 수신 및 최근 액션 목록 자동 갱신 확인.
	- OpenAPI 문서 노출 정상(`/docs`), Alembic heads 단일 유지(스키마 변경 없음).

- 다음 단계
	1) 프로필/보상/스트릭/통계 이벤트도 허브 헬퍼로 일원화(broadcast_profile_update 등 실제 호출부 연결).
	2) 프론트 전역 컨텍스트에서 이벤트 라우팅(헤더 배지, 프로필, 미션 패널 동기화) 추가.
	3) 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 및 SSE 대안 경로 문서화.

---

### 2025-08-23 – 환경 자동화 및 보상 브로드캐스트 추가

- 변경 요약
	- 루트 스크립트 `cc-manage.ps1`가 `.env` 부재 시 `.env.development`를 자동 복사하여 생성하도록 보강.
	- `POST /api/rewards/distribute` 처리 후 실시간 허브로 `reward_granted`와 `profile_update(gold_balance)` 이벤트를 브로드캐스트(최소 침습, best-effort).
- 검증
	- `.env`가 없는 환경에서 `./cc-manage.ps1 start` 실행 → "Created .env from .env.development" 메시지 확인.
	- 보상 분배 후 동일 사용자 세션에서 `reward_granted` 및 `profile_update` 이벤트 수신, 프론트 잔액/배지 갱신 확인.
- 다음 단계
	1) 미션/이벤트 클레임 및 상점 결제 성공 경로에도 동일 스키마로 브로드캐스트 일원화 점검.
	2) pytest 스모크에 액션→최근액션→(옵션)WS 수신 최소 시나리오 추가.
	3) OpenAPI 스펙 변화 없으나 필요 시 재수출로 문서 동기화 확인.

---

### 2025-08-23 – 상점/결제 WS 브로드캐스트 보강 및 정산/웹훅 연동

- 변경 요약
	- `/api/shop/buy`: 모든 분기에 `purchase_update` 브로드캐스트 추가(success/failed/pending/idempotent_reuse/grant_failed/insufficient_funds/item_purchase_failed). 성공 시 `profile_update(gold_balance)` 동반 송신.
	- `/api/shop/limited/buy` 및 compat 경로: 성공/실패/중복 재사용 시 `purchase_update`+ 성공 시 `profile_update` 송신.
	- `/api/shop/webhook/payment`: HMAC 검증·재생 방어·멱등 처리 후, payload 내 `user_id`/`status` 등 존재 시 비차단 브로드캐스트.
	- `/api/shop/transactions/{receipt}/settle`: 메서드명 수정(gems→gold), 정산 결과에 따른 `purchase_update` 및 성공 시 `profile_update` 송신.

- 검증
	- 로컬에서 성공/실패/보류/중복 재사용 케이스의 WS 이벤트 수신 확인. OpenAPI 경로 변화 없음, Alembic 변경 없음 → head 단일 유지.

- 다음 단계
	1) 프론트 공통 WS 핸들러에서 `purchase_update` 구독하여 토스트/잔액/배지 갱신 연결.
	2) 웹훅 표준 payload 스키마 문서화 및 리그레션 테스트 추가.
	3) Prometheus Counter(`purchase_attempt_total`) 대시보드 반영.

---

### 2025-08-23 – Frontend 구독 연결 메모 (purchase_update)

- 변경 요약: 프론트 `RealtimeSyncContext`가 WebSocket `purchase_update` 이벤트를 처리하여 토스트 알림을 노출(성공/실패/멱등/진행중). 잔액은 `profile_update` 이벤트로 동기화.
- 영향: OpenAPI/Alembic 스키마 변경 없음. 백엔드 브로드캐스트 스키마는 `{ type:"purchase_update", user_id, data:{ status, product_id?, receipt_code?, amount?, reason_code? } }`로 유지.
- 후속: pending→success 전이 시 중복 알림 억제 로직 튜닝, 배지/장바구니 UI 연동.

#### 결제 웹훅 Payload 스키마 (문서化)
- 엔드포인트: `POST /api/shop/webhook/payment`
- 헤더: `X-Signature: <HMAC_SHA256>` (비밀키 + `timestamp:nonce:body`), `X-Timestamp`, `X-Nonce`
- 바디(JSON):
	- `event_id` (string) 고유 이벤트 ID (멱등키)
	- `user_id` (int)
	- `status` (string: pending|success|failed)
	- `product_id` (string)
	- `receipt_code` (string)
	- `amount` (int) 센트 또는 내부 기준 단위
	- `reason_code` (string, 선택)
	- `new_gold_balance` (int, 선택)
- 브로드캐스트: 유효 payload 시 `purchase_update`(+ 성공 시 `profile_update`) 비차단 송신

---

### 2025-08-24 – 모니터링 튜닝(대시보드/알림)

- 변경 요약
	- Grafana 대시보드 `grafana_dashboard.json`: 구매 실패 사유 패널 라벨 수정(failed→fail), Purchase Success % 패널에 데이터소스 명시 및 임계치 단계(95/98) 추가.
	- Prometheus 룰 `purchase_alerts.yml`: 백엔드 5xx 비율 경보(Http5xxRateHigh, 5m 2%+), HTTP P95 지연 경보(HttpLatencyP95High, 0.8s 10m).
- 검증
	- PromQL 및 라벨 일치 확인, 프로비저닝 경로 변경 없음. OpenAPI/Alembic 영향 없음.
- 다음 단계
	- 실데이터 기반 임계 보정(성공율 99% 상향 검토), pending 스파이크 임계 환경별 분리, pytest 빠른 승리 케이스부터 복구.

### 2025-08-24 – 알림 임계 외부화(ENV)

- 변경 요약
	- Prometheus 구매 알림 룰을 템플릿(`cc-webapp/monitoring/purchase_alerts.tmpl.yml`)로 분리하고, PowerShell 렌더 스크립트 `scripts/render_prometheus_rules.ps1` 추가.
	- `./cc-manage.ps1 tools start` 시 템플릿을 렌더링하여 실제 룰 파일(`purchase_alerts.yml`) 생성. ENV `ALERT_PENDING_SPIKE_THRESHOLD`로 임계값 주입(기본 20).
- 사용 방법
	1) PowerShell에서 `setx ALERT_PENDING_SPIKE_THRESHOLD 30` 실행(새 세션 필요) 또는 세션 내 `$env:ALERT_PENDING_SPIKE_THRESHOLD=30` 지정.
	2) `./cc-manage.ps1 tools start` 실행 → 렌더 로그에서 값 확인.
	3) Prometheus 재기동 후 Rules 탭에서 PurchasePendingSpike 식에 반영된 임계 확인.
- 다음 단계
	- dev/tools/prod 프로파일별 기본값을 `.env.*`에 정의하고 CI/문서 동기화.

### 2025-08-22 – HomeDashboard 최근 액션 섹션 추가

- 변경 요약
	- 홈 대시보드 우측 패널에 "최근 액션" 카드 추가. 백엔드 `GET /api/actions/recent/{user_id}` 바인딩.
	- `hooks/useRecentActions` 훅 신설(1초 TTL dedupe)로 목록 로딩 및 재호출 최소화.
	- 통합 클라이언트 `unifiedApi` 사용으로 경로 규칙 통일(`/api` 접두사 자동 처리).

- 검증
	- Docker 환경에서 로그인 후 대시보드 진입 시 최근 액션 목록 노출(없으면 안내 문구 표시).
	- 테스트 액션 생성 후 목록 갱신으로 즉시 반영 확인.
	- /health 200, /docs 정상 노출. Alembic heads 단일 유지.

- 다음 단계
	1) WebSocket 연동(선택): USER_ACTION 이벤트 수신 시 프론트 목록 prepend 실시간 반영.
	2) ClickHouse 파이프라인 활성 시 OLAP 기반 차트 위젯 추가 검토.
	3) 백엔드 대시보드 통합 응답에 최근 액션 포함 시 프론트 훅 단순화.

---

### 2025-08-20 – Global Metrics 엔드포인트 (`GET /api/metrics/global`)

- 목적: 초기 사용자 Social Proof 제공 (개인 데이터와 명확 분리)
- 응답 필드:
	- online_users: 최근 5분 내 활동 세션 수 (distinct user_id)
	- spins_last_hour: 지난 1시간 SLOT_SPIN 액션 수
	- big_wins_last_hour: 지난 1시간 고액(reward.amount_gold > 1000) 보상 수
	- generated_at: 서버 집계 시각(UTC)
- 캐시: Redis 키 `metrics:global:v1` TTL=5s (짧은 폴링/향후 SSE 전환 용이)
- SSE: `GET /api/metrics/stream` (event: metrics, 기본 5초 간격, ?interval=2~30)
- 개인 정보: 없음 (집계 전용) → 퍼블릭 캐시 안전
- 사용 가이드: 홈 대시보드 CommunityPulse 컴포넌트 폴링(10s) 또는 SSE 대체
- 추후 확장 후보: total_plays_today, unique_payers_last_24h, active_events_count
- 환경 변수: `BIG_WIN_THRESHOLD_GOLD` (기본 1000) → big_wins_last_hour 집계 임곗값

---

### 2025-08-20 – Admin Stats 확장 (online_users / revenue / alerts / pending)

- 변경 요약
	- `GET /api/admin/stats` 응답 스키마 확장: `online_users`, `total_revenue`, `today_revenue`, `pending_actions`, `critical_alerts`, `generated_at` 추가.
	- AdminService에 `get_system_stats_extended` 추가(멀티 테이블 집계 + 시간 윈도우).
	- Redis 캐시(키: `admin:stats:cache:v1`, TTL=5s) 도입으로 고빈도 폴링 부하 완화.
	- 기존 기본 필드(예: total_users 등)는 기존 get_system_stats 결과 포함 방식 유지(역호환).

- 필드 정의
	- online_users: 최근 5분 내 `user_sessions.last_seen > now - 5m` 인 DISTINCT user_id 수.
	- total_revenue: `shop_transactions` 성공(success) 누적 금액 합(sum(amount_gold)).
	- today_revenue: 오늘 00:00(UTC 기준) 이후 성공 결제 금액 합.
	- pending_actions: 상태가 'pending' 인 결제/액션(현재 트랜잭션/처리 대기) 카운트.
	- critical_alerts: 최근 10분 내 AdminAuditLog (action ∈ CRITICAL 집합) 레코드 수.
	- generated_at: 집계 계산 시점(캐시 재사용 시 캐시 생성 시각).

- 수집/쿼리 개요 (의사 SQL)
```sql
-- online_users
SELECT COUNT(DISTINCT user_id) FROM user_sessions WHERE last_seen > now() - interval '5 minutes';
-- total_revenue
SELECT COALESCE(SUM(amount_gold),0) FROM shop_transactions WHERE status='success';
-- today_revenue
SELECT COALESCE(SUM(amount_gold),0) FROM shop_transactions WHERE status='success' AND created_at >= date_trunc('day', now());
-- pending_actions (현재 구매 pending 기준)
SELECT COUNT(*) FROM shop_transactions WHERE status='pending';
-- critical_alerts (예: action IN ('SECURITY_BAN','PAYMENT_FRAUD','ANOMALY_SPIKE'))
SELECT COUNT(*) FROM admin_audit_logs WHERE action = ANY(:critical_list) AND created_at > now() - interval '10 minutes';
```

- 캐시 전략
	- Key: `admin:stats:cache:v1` (버전 접미사로 향후 스키마 변경 시 충돌 회피).
	- TTL: 5초 (UI 폴링 5~10s 권장; SSE 도입 시 폴백 용도로만 사용 예정).
	- Invalidation: 자연 만료(짧은 TTL). 대규모 이벤트(대량 지급, 시스템 리셋) 발생 시 수동 삭제 고려 (`DEL` 호출 백엔드 유틸 추가 예정).

- 검증
	- 신규 통합 테스트 `app/tests/test_admin_stats.py`: 필드 존재/타입 및 today_revenue <= total_revenue 관계 확인.
	- 로컬 수동 호출 2회(5s 내 재호출)시 두 번째 응답 generated_at 동일 → 캐시 HIT 확인.
	- 캐시 만료 후 재호출 generated_at 갱신.
	- Alembic 변경 없음(head 단일 유지), OpenAPI 스키마 확장 필요 → 재수출 예정.

- 영향 범위 및 위험도
	- 단순 읽기 집계 + 짧은 TTL 캐싱: 잠재적 N+1 없음(집계 별 개별 쿼리, 추후 UNION ALL 서브쿼리 최적화 후보).
	- 고동시 트래픽: 5s 캐시로 초당 수십 RPS 수준까지 DB 부하 경감 기대.
	- Revenue 합계 계산 시 long-running 트랜잭션 영향 거의 없음(READ COMMITTED 스냅샷).

- 다음 단계(TODO)
	1) Batch User Import (CSV/XLSX) → `/api/admin/users/import?dry_run=1` 설계 및 검증 오류 포맷 정의.
	2) SSE 스트림 `/api/admin/stream` (이벤트: stats, alert, transaction) + 캐시 fallback 문서화.
	3) critical_alerts 분류 체계 확장(심각도 레벨/룰 기반 등록) 및 Admin 설정 UI.
	4) today_revenue 시간대 로컬라이즈 또는 타임존 파라미터 지원 검토.
	5) pending_actions 범위 확장(예: 오래된 pending 자동 VOID 대기 숫자 별도 분리).

---

### 2025-08-20 – AUTO_SEED_BASIC & 로그인 응답 구조 개선

- 변경 요약
	- 서버 startup lifespan 에 `AUTO_SEED_BASIC=1` 시 기본 계정(admin,user001~004) 멱등 시드 자동 수행.
	- 시드 적용 시 로그: `AUTO_SEED_BASIC 적용:` 출력, `app.state.auto_seed_basic_applied=True` 설정.
	- 로그인 실패/잠금 HTTP 응답 detail 구조 JSON 객체로 변경:
		- 401: `{ "error": "invalid_credentials", "message": "아이디 또는 비밀번호가 올바르지 않습니다." }`
		- 429: `{ "error": "login_locked", "message": "로그인 시도 제한을 초과했습니다. 잠시 후 다시 시도해주세요.", "retry_after_minutes": <int> }`
	- 프론트는 error 키로 분기하여 UX(카운트다운, 강조 메시지) 표준화 가능.
- 검증
	- admin 존재하지 않는 fresh DB + `AUTO_SEED_BASIC=1` → 부팅 로그에서 적용 문구 확인 후 `/api/auth/login` 성공.
	- 잘못된 비밀번호 1~5회: 401 payload.error=invalid_credentials, 6회→429 payload.error=login_locked.
- 위험/주의
	- 프로덕션에서 의도치 않은 시드 방지: ENV 기본값 0, 존재 확인 후만 실행.
	- seed 스크립트는 항상 비밀번호 재해시 → 의도치 않은 패스워드 리셋을 피하려면 prod 활성화 금지.
- 다음 단계
	1) AdminStats 응답에 `auto_seed_applied` (boolean) 포함 여부 결정.
	2) 실패 횟수/남은 잠금시간 미들웨어 노출 `/api/auth/login` 헤더(예: X-Login-Lock-Retry) 검토.
	3) seed 적용 결과 Prometheus Gauge(cc_auto_seed_basic_applied) 추가.

---

### 2025-08-31 – FE Providers 클라이언트 경계 보정 및 스모크 재검증

- 변경 요약
	- frontend/lib/sync.ts와 store/globalStore.tsx에 "use client" 선언을 명시해 Providers 트리 내 EnsureHydrated/RealtimeSyncProvider/GlobalStoreProvider가 서버 컴포넌트로 오인되지 않도록 보정.
	- app/providers.tsx에 개발용 런타임 가드(누락 import 탐지 로그) 추가. 개발 중 “Element type is invalid… Check the render method of Providers” 재발 방지.
	- 개발 환경의 API ORIGIN은 NEXT_PUBLIC_API_ORIGIN=http://localhost:8000 유지(이전 조치 확인).

- 검증 결과
	- 컨테이너 기반 Playwright: 31 passed / 11 skipped / 3 failed. Providers 렌더 오류(Invalid element type) 재현되지 않음.
	- 백엔드 OpenAPI/Alembic 스키마 변경 없음(재수출 불필요). /docs 정상 노출(이전 상태 유지).

- 다음 단계
	1) 실패 테스트 triage: action_history_pagination(프로필 테스트 페이지 data-testid 불일치) 및 admin_points_ui(버튼 disabled) 원인 분석 후 테스트/컴포넌트 정합화.
	2) 필요 시 테스트 가드/대기 조건 개선 및 data-testid 보강, CI 녹색 유지.
	3) 변경 지속 시 본 문서에 결과 갱신 및 최소 재검증(스모크) 반복.


## 2025-08-31 – 인증 블랙리스트/세션 하드닝 및 시드 활동 스모크 결과

- 변경 요약
	- 의존성(`app/dependencies.py`)의 비검증 클레임 폴백 기본 비활성화. 개발/테스트 한정 ENV(`ALLOW_UNVERIFIED_DEP_FALLBACK=1`)에서만 허용.
	- `verify_token`에서 세션 존재 강제(기본). 미존재 시 401; 완화는 ENV(`ALLOW_MISSING_SESSION=1`)로만 허용. 로그아웃 시 jti를 Redis/DB 블랙리스트에 저장하여 재사용 차단.
	- 시드 스모크 스크립트(`app.scripts.smoke_seed_activity`) 추가: 로그인→RPS→카탈로그 조회. “가짜 데이터 금지/실제 활동만 유지” 정책 하에서 데이터 반영 확인.

- 검증 결과
	- pytest(auth) 서브스위트 16 passed(블랙리스트/세션 스펙 포함). `/health` 200, Alembic heads 단일 유지.
	- 시드 스모크 실행 로그: RPS 200 응답(balance 1010 반영), Catalog 200.

- 다음 단계
	1) 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 및 `current_openapi.json` 동기화.
	2) 상점 구매 스모크를 위해 카탈로그 항목 보장 후 buy 단계 추가 실행(영수증/토스트 확인).
	3) 컨테이너 Playwright 전 스위트 재실행(0 failed 유지) 및 본 문서에 결과 반영.


### 2025-08-25 – Frontend ESLint 금지 경로 추가

- 변경 요약
	- 프론트엔드 ESLint에 문자열 리터럴 `'/api/users/profile'` 사용 금지 룰 추가. 대안: `'/api/users/me'`.
	- 루트 ESLint에도 동일 규칙 적용하여 편차 방지.

- 영향/검증
	- 프론트엔드 `npm run lint`에서 위 문자열 사용 코드가 에러 처리되어 CI 차단 가능.
	- 백엔드 OpenAPI/Alembic 무영향.

- 다음 단계
	1) 코드베이스 grep으로 잔존 사용처 제거.
	2) WS selector 마이그레이션과 폴링 표준화 진행.
	3) 컨테이너 내부 pytest 스모크(결제/스트릭) 결과 문서화.

### 2025-08-22 – Frontend unifiedApi migration (Profile, Events)

- 변경 요약
	- ProfileScreen: utils/apiClient.userApi 의존 제거 → unifiedApi(api.get) 사용으로 전환. 호출 경로: users/profile, users/stats, users/balance. 데이터 정규화 로직은 유지.
	- useEvents 훅: legacy apiClient 제거 → unifiedApi(api.get/post/put)로 전환. 경로: events/, events/join, events/claim/{id}, events/progress/{id}. 캐시/비로그인 스킵/리스너 구조는 유지.
	- BUILD_ID 배너: simpleApi에서 분리하여 lib/buildInfo.ts 신설 후 HomeDashboard가 이를 임포트하도록 변경.

- 영향 및 위험
	- 토큰/리프레시/재시도 동작은 unifiedApi 공통 정책(401 1회 refresh, 지수백오프)으로 통일. 과거 apiClient의 세부 로그/트레이스는 해당 컴포넌트 경로에서 더 이상 호출되지 않음.
	- API 경로 접두사 차이 고려: unifiedApi는 '/api/' 없이 상대 경로 사용. 기존 호출 대비 네임스페이스 오타 주의. 기본 smoke로 대시보드/이벤트 목록/조인/클레임 경로 확인 필요.

- 후속 작업
	1) 게임 컴포넌트(슬롯/크래시/가챠) 및 NotificationToast, useAuth 등 남은 apiClient/useApiClient 의존 제거.
	2) 간단한 E2E 또는 Playwright 스모크에서 이벤트 플로우 확인(join→progress→claim).
	3) simpleApi 완전 제거 전, 임시로 남은 파일들의 사용처 정리 및 제거 시점 명시.

---

### 2025-08-22 – Realtime 허브 통합 및 USER_ACTION 브로드캐스트 표준화

- 변경 요약
	- `/api/realtime/sync` WebSocket 라우터 활성화(메인 앱에 include). 초기 메시지 `sync_connected` 및 `initial_state` 제공.
	- 액션 로깅 경로(`/api/actions`)가 실시간 허브를 통해 표준 스키마로 브로드캐스트: `{ type: "user_action", user_id, data: { user_id, action_type, client_ts, context, server_ts } }`.
	- 레거시 `app.websockets.manager` 호환 어댑터 추가: `payload` 키 사용 시 자동으로 `data`로 정규화하여 허브로 위임.

- 검증
	- 대시보드 로그인 → 프론트 .env(NEXT_PUBLIC_REALTIME_ENABLED=1) 설정 시 WS 연결 확인(`sync_connected`, `initial_state` 수신).
	- POST `/api/actions` 호출 후 같은 사용자 세션에서 `type=user_action` 이벤트 수신 및 최근 액션 목록 자동 갱신 확인.
	- OpenAPI 문서 노출 정상(`/docs`), Alembic heads 단일 유지(스키마 변경 없음).

- 다음 단계
	1) 프로필/보상/스트릭/통계 이벤트도 허브 헬퍼로 일원화(broadcast_profile_update 등 실제 호출부 연결).
	2) 프론트 전역 컨텍스트에서 이벤트 라우팅(헤더 배지, 프로필, 미션 패널 동기화) 추가.
	3) 필요 시 OpenAPI 재수출(`python -m app.export_openapi`) 및 SSE 대안 경로 문서화.

---

### 2025-08-23 – 환경 자동화 및 보상 브로드캐스트 추가

- 변경 요약
	- 루트 스크립트 `cc-manage.ps1`가 `.env` 부재 시 `.env.development`를 자동 복사하여 생성하도록 보강.
	- `POST /api/rewards/distribute` 처리 후 실시간 허브로 `reward_granted`와 `profile_update(gold_balance)` 이벤트를 브로드캐스트(최소 침습, best-effort).
- 검증
	- `.env`가 없는 환경에서 `./cc-manage.ps1 start` 실행 → "Created .env from .env.development" 메시지 확인.
	- 보상 분배 후 동일 사용자 세션에서 `reward_granted` 및 `profile_update` 이벤트 수신, 프론트 잔액/배지 갱신 확인.
- 다음 단계
	1) 미션/이벤트 클레임 및 상점 결제 성공 경로에도 동일 스키마로 브로드캐스트 일원화 점검.
	2) pytest 스모크에 액션→최근액션→(옵션)WS 수신 최소 시나리오 추가.
	3) OpenAPI 스펙 변화 없으나 필요 시 재수출로 문서 동기화 확인.

---

### 2025-08-23 – 상점/결제 WS 브로드캐스트 보강 및 정산/웹훅 연동

- 변경 요약
	- `/api/shop/buy`: 모든 분기에 `purchase_update` 브로드캐스트 추가(success/failed/pending/idempotent_reuse/grant_failed/insufficient_funds/item_purchase_failed). 성공 시 `profile_update(gold_balance)` 동반 송신.
	- `/api/shop/limited/buy` 및 compat 경로: 성공/실패/중복 재사용 시 `purchase_update`+ 성공 시 `profile_update` 송신.
	- `/api/shop/webhook/payment`: HMAC 검증·재생 방어·멱등 처리 후, payload 내 `user_id`/`status` 등 존재 시 비차단 브로드캐스트.
	- `/api/shop/transactions/{receipt}/settle`: 메서드명 수정(gems→gold), 정산 결과에 따른 `purchase_update` 및 성공 시 `profile_update` 송신.

- 검증
	- 로컬에서 성공/실패/보류/중복 재사용 케이스의 WS 이벤트 수신 확인. OpenAPI 경로 변화 없음, Alembic 변경 없음 → head 단일 유지.

- 다음 단계
	1) 프론트 공통 WS 핸들러에서 `purchase_update` 구독하여 토스트/잔액/배지 갱신 연결.
	2) 웹훅 표준 payload 스키마 문서화 및 리그레션 테스트 추가.
	3) Prometheus Counter(`purchase_attempt_total`) 대시보드 반영.

---

### 2025-08-23 – Frontend 구독 연결 메모 (purchase_update)

- 변경 요약: 프론트 `RealtimeSyncContext`가 WebSocket `purchase_update` 이벤트를 처리하여 토스트 알림을 노출(성공/실패/멱등/진행중). 잔액은 `profile_update` 이벤트로 동기화.
- 영향: OpenAPI/Alembic 스키마 변경 없음. 백엔드 브로드캐스트 스키마는 `{ type:"purchase_update", user_id, data:{ status, product_id?, receipt_code?, amount?, reason_code? } }`로 유지.
- 후속: pending→success 전이 시 중복 알림 억제 로직 튜닝, 배지/장바구니 UI 연동.

#### 결제 웹훅 Payload 스키마 (문서化)
- 엔드포인트: `POST /api/shop/webhook/payment`
- 헤더: `X-Signature: <HMAC_SHA256>` (비밀키 + `timestamp:nonce:body`), `X-Timestamp`, `X-Nonce`
- 바디(JSON):
	- `event_id` (string) 고유 이벤트 ID (멱등키)
	- `user_id` (int)
	- `status` (string: pending|success|failed)
	- `product_id` (string)
	- `receipt_code` (string)
	- `amount` (int) 센트 또는 내부 기준 단위
	- `reason_code` (string, 선택)
	- `new_gold_balance` (int, 선택)
- 브로드캐스트: 유효 payload 시 `purchase_update`(+ 성공 시 `profile_update`) 비차단 송신

---

### 2025-08-24 – 모니터링 튜닝(대시보드/알림)

- 변경 요약
	- Grafana 대시보드 `grafana_dashboard.json`: 구매 실패 사유 패널 라벨 수정(failed→fail), Purchase Success % 패널에 데이터소스 명시 및 임계치 단계(95/98) 추가.
	- Prometheus 룰 `purchase_alerts.yml`: 백엔드 5xx 비율 경보(Http5xxRateHigh, 5m 2%+), HTTP P95 지연 경보(HttpLatencyP95High, 0.8s 10m).
- 검증
	- PromQL 및 라벨 일치 확인, 프로비저닝 경로 변경 없음. OpenAPI/Alembic 영향 없음.
- 다음 단계
	- 실데이터 기반 임계 보정(성공율 99% 상향 검토), pending 스파이크 임계 환경별 분리, pytest 빠른 승리 케이스부터 복구.

### 2025-08-24 – 알림 임계 외부화(ENV)

- 변경 요약
	- Prometheus 구매 알림 룰을 템플릿(`cc-webapp/monitoring/purchase_alerts.tmpl.yml`)로 분리하고, PowerShell 렌더 스크립트 `scripts/render_prometheus_rules.ps1` 추가.
	- `./cc-manage.ps1 tools start` 시 템플릿을 렌더링하여 실제 룰 파일(`purchase_alerts.yml`) 생성. ENV `ALERT_PENDING_SPIKE_THRESHOLD`로 임계값 주입(기본 20).
- 사용 방법
	1) PowerShell에서 `setx ALERT_PENDING_SPIKE_THRESHOLD 30` 실행(새 세션 필요) 또는 세션 내 `$env:ALERT_PENDING_SPIKE_THRESHOLD=30` 지정.
	2) `./cc-manage.ps1 tools start` 실행 → 렌더 로그에서 값 확인.
	3) Prometheus 재기동 후 Rules 탭에서 PurchasePendingSpike 식에 반영된 임계 확인.
- 다음 단계
	- dev/tools/prod 프로파일별 기본값을 `.env.*`에 정의하고 CI/문서 동기화.

### 2025-08-22 – HomeDashboard 최근 액션 섹션 추가

- 변경 요약
	- 홈 대시보드 우측 패널에 "최근 액션" 카드 추가. 백엔드 `GET /api/actions/recent/{user_id}` 바인딩.
	- `hooks/useRecentActions` 훅 신설(1초 TTL dedupe)로 목록 로딩 및 재호출 최소화.
	- 통합 클라이언트 `unifiedApi` 사용으로 경로 규칙 통일(`/api` 접두사 자동 처리).

- 검증
	- Docker 환경에서 로그인 후 대시보드 진입 시 최근 액션 목록 노출(없으면 안내 문구 표시).
	- 테스트 액션 생성 후 목록 갱신으로 즉시 반영 확인.
	- /health 200, /docs 정상 노출. Alembic heads 단일 유지.

- 다음 단계
	1) WebSocket 연동(선택): USER_ACTION 이벤트 수신 시 프론트 목록 prepend 실시간 반영.
	2) ClickHouse 파이프라인 활성 시 OLAP 기반 차트 위젯 추가 검토.
	3) 백엔드 대시보드 통합 응답에 최근 액션 포함 시 프론트 훅 단순화.

---

### 2025-08-20 – Global Metrics 엔드포인트 (`GET /api/metrics/global`)

- 목적: 초기 사용자 Social Proof 제공 (개인 데이터와 명확 분리)
- 응답 필드:
	- online_users: 최근 5분 내 활동 세션 수 (distinct user_id)
	- spins_last_hour: 지난 1시간 SLOT_SPIN 액션 수
	- big_wins_last_hour: 지난 1시간 고액(reward.amount_gold > 1000) 보상 수
	- generated_at: 서버 집계 시각(UTC)
- 캐시: Redis 키 `metrics:global:v1` TTL=5s (짧은 폴링/향후 SSE 전환 용이)
- SSE: `GET /api/metrics/stream` (event: metrics, 기본 5초 간격, ?interval=2~30)
- 개인 정보: 없음 (집계 전용) → 퍼블릭 캐시 안전
- 사용 가이드: 홈 대시보드 CommunityPulse 컴포넌트 폴링(10s) 또는 SSE 대체
- 추후 확장 후보: total_plays_today, unique_payers_last_24h, active_events_count
- 환경 변수: `BIG_WIN_THRESHOLD_GOLD` (기본 1000) → big_wins_last_hour 집계 임곗값

---

### 2025-08-20 – Admin Stats 확장 (online_users / revenue / alerts / pending)

- 변경 요약
	- `GET /api/admin/stats` 응답 스키마 확장: `online_users`, `total_revenue`, `today_revenue`, `pending_actions`, `critical_alerts`, `generated_at` 추가.
	- AdminService에 `get_system_stats_extended` 추가(멀티 테이블 집계 + 시간 윈도우).
	- Redis 캐시(키: `admin:stats:cache:v1`, TTL=5s) 도입으로 고빈도 폴링 부하 완화.
	- 기존 기본 필드(예: total_users 등)는 기존 get_system_stats 결과 포함 방식 유지(역호환).

- 필드 정의
	- online_users: 최근 5분 내 `user_sessions.last_seen > now - 5m` 인 DISTINCT user_id 수.
	- total_revenue: `shop_transactions` 성공(success) 누적 금액 합(sum(amount_gold)).
	- today_revenue: 오늘 00:00(UTC 기준) 이후 성공 결제 금액 합.
	- pending_actions: 상태가 'pending' 인 결제/액션(현재 트랜잭션/처리 대기) 카운트.
	- critical_alerts: 최근 10분 내 AdminAuditLog (action ∈ CRITICAL 집합) 레코드 수.
	- generated_at: 집계 계산 시점(캐시 재사용 시 캐시 생성 시각).

- 수집/쿼리 개요 (의사 SQL)
```sql
-- online_users
SELECT COUNT(DISTINCT user_id) FROM user_sessions WHERE last_seen > now() - interval '5 minutes';
-- total_revenue
SELECT COALESCE(SUM(amount_gold),0) FROM shop_transactions WHERE status='success';
-- today_revenue
SELECT COALESCE(SUM(amount_gold),0) FROM shop_transactions WHERE status='success' AND created_at >= date_trunc('day', now());
-- pending_actions (현재 구매 pending 기준)
SELECT COUNT(*) FROM shop_transactions WHERE status='pending';
-- critical_alerts (예: action IN ('SECURITY_BAN','PAYMENT_FRAUD','ANOMALY_SPIKE'))
SELECT COUNT(*) FROM admin_audit_logs WHERE action = ANY(:critical_list) AND created_at > now() - interval '10 minutes';
```

- 캐시 전략
	- Key: `admin:stats:cache:v1` (버전 접미사로 향후 스키마 변경 시 충돌 회피).
	- TTL: 5초 (UI 폴링 5~10s 권장; SSE 도입 시 폴백 용도로만 사용 예정).
	- Invalidation: 자연 만료(짧은 TTL). 대규모 이벤트(대량 지급, 시스템 리셋) 발생 시 수동 삭제 고려 (`DEL` 호출 백엔드 유틸 추가 예정).

- 검증
	- 신규 통합 테스트 `app/tests/test_admin_stats.py`: 필드 존재/타입 및 today_revenue <= total_revenue 관계 확인.
	- 로컬 수동 호출 2회(5s 내 재호출)시 두 번째 응답 generated_at 동일 → 캐시 HIT 확인.
	- 캐시 만료 후 재호출 generated_at 갱신.
	- Alembic 변경 없음(head 단일 유지), OpenAPI 스키마 확장 필요 → 재수출 예정.

- 영향 범위 및 위험도
	- 단순 읽기 집계 + 짧은 TTL 캐싱: 잠재적 N+1 없음(집계 별 개별 쿼리, 추후 UNION ALL 서브쿼리 최적화 후보).
	- 고동시 트래픽: 5s 캐시로 초당 수십 RPS 수준까지 DB 부하 경감 기대.
	- Revenue 합계 계산 시 long-running 트랜잭션 영향 거의 없음(READ COMMITTED 스냅샷).

- 다음 단계(TODO)
	1) Batch User Import (CSV/XLSX) → `/api/admin/users/import?dry_run=1` 설계 및 검증 오류 포맷 정의.
	2) SSE 스트림 `/api/admin/stream` (이벤트: stats, alert, transaction) + 캐시 fallback 문서화.
	3) critical_alerts 분류 체계 확장(심각도 레벨/룰 기반 등록) 및 Admin 설정 UI.
	4) today_revenue 시간대 로컬라이즈 또는 타임존 파라미터 지원 검토.
	5) pending_actions 범위 확장(예: 오래된 pending 자동 VOID 대기 숫자 별도 분리).

## 변경 요약 (2025-09-01)
- 전역동기화 TODO 세분화 및 체크박스 추가: 분산 훅 스윕 하위작업/파리티 승격 절차를 문서화.
- 레거시 훅 폐기 고지: `frontend/hooks/useBalanceSync.ts`, `frontend/hooks/useDashboard.ts`에 @deprecated 주석 반영.
- 컨테이너 Playwright 1회 실행 결과: 37 passed / 12 skipped / 0 failed. `/api/games/stats/me` smoke PASS로 200 1차 확인.

### 검증
- E2E(컨테이너): green 1회. stats UI parity 스펙은 가드로 skip.
- Backend(pytest): GameStats 파일 그린 유지(참고 지표).
- Alembic heads: 변경 없음 (이번 커밋은 FE/문서만 변경).

### 다음 단계
- `/api/games/stats/me` 200 재확인(#2) 및 UI=API 파리티 PASS 3회 연속 확보.
- 컨테이너 Playwright 2회 추가 실행 → 3회 연속 green 증적 확보 후 STRICT_STATS_PARITY=1 승격 준비.
- 호출처 대체: useBalanceSync/useDashboard 제거 전 useGlobalSync/useGameStats로 대체 및 스모크 1회.

